# Story 3.4 — Multiple Income Streams Implementation Plan

## Overview

This plan implements support for multiple income streams in the retirement projection engine, replacing the current single Social Security income source with a flexible array of income streams that can start at different ages.

**Scope Decision**: Based on the research document, we are keeping expenses simple (general + healthcare split) and focusing this story entirely on **income streams**.

## Current State Analysis

### What Exists Now

1. **Projection Engine** ([engine.ts:158-162](src/lib/projections/engine.ts#L158-L162))
   - Single Social Security income source
   - Income starts at `socialSecurityAge`
   - Income is inflation-adjusted using general inflation rate
   - Formula: `(socialSecurityMonthly * 12) * inflationMultiplier`

2. **Type Definitions** ([types.ts:61-63](src/lib/projections/types.ts#L61-L63))
   ```typescript
   socialSecurityAge: number;
   socialSecurityMonthly: number;
   ```

3. **Database Schema** ([financial-snapshot.ts:40-62](src/db/schema/financial-snapshot.ts#L40-L62))
   - No `incomeStreams` column exists
   - Social Security is derived/estimated at projection time via `estimateSocialSecurityMonthly()`

4. **API Route** ([route.ts:111-113](src/app/api/projections/calculate/route.ts#L111-L113))
   - Builds `socialSecurityAge` and `socialSecurityMonthly` from defaults + overrides
   - Uses `estimateSocialSecurityMonthly()` from assumptions module

### Key Patterns to Preserve

- Income reduces portfolio withdrawal needs: `withdrawalNeeded = max(0, expenses - income)`
- Age-based activation: income starts/ends at specific ages
- Inflation adjustment via compound formula: `amount * Math.pow(1 + rate, yearsFromRetirement)`
- JSONB storage pattern for arrays (same as `investmentAccounts`, `debts`)

## Desired End State

After implementation:

1. **Data Model**: `financial_snapshot` table has `income_streams` JSONB column storing an array of income stream objects
2. **Type System**: `IncomeStream` interface with id, name, type, annualAmount, startAge, endAge, inflationAdjusted
3. **Engine**: Loops over all income streams, calculating total income per year
4. **Onboarding**: New step to collect income streams (or extension of existing step)
5. **Profile Editing**: Users can view and edit income streams from the profile page
6. **Backward Compatibility**: Legacy SS fields auto-converted to income stream at read time

### Verification

- [ ] Existing projections continue to work identically (backward compatibility)
- [ ] New income streams are persisted and retrieved correctly
- [ ] Projection correctly sums multiple income sources per year
- [ ] Income streams with different start ages activate at correct times
- [ ] Inflation-adjusted streams compound annually; fixed streams stay constant
- [ ] Profile page displays income streams section with edit capability

## What We're NOT Doing

- **Expense categories**: Keeping current general + healthcare split
- **Tax modeling**: No partial taxability of income (e.g., 85% SS taxable)
- **Database migration**: Using read-time auto-migration for legacy data

## Implementation Approach

We will implement in phases:
1. Type system and database schema
2. Projection engine modifications
3. API route updates with backward compatibility
4. Onboarding UI for income stream collection
5. Profile UI for editing income streams
6. Tests

---

## Phase 1: Type System & Database Schema

### Overview
Add the `IncomeStream` type and database column to support storing multiple income streams.

### Changes Required:

#### 1. Add IncomeStreamJson type to schema
**File**: [src/db/schema/financial-snapshot.ts](src/db/schema/financial-snapshot.ts)

Add type definition after `IncomeExpensesJson` (around line 38):

```typescript
export type IncomeStreamJson = {
  id: string;
  name: string;
  type: 'social_security' | 'pension' | 'rental' | 'annuity' | 'part_time' | 'other';
  annualAmount: number;
  startAge: number;
  endAge?: number;
  inflationAdjusted: boolean;
};
```

Add column to table (around line 58, after `incomeExpenses`):

```typescript
incomeStreams: jsonb('income_streams').$type<IncomeStreamJson[]>(),
```

#### 2. Add IncomeStream interface to projection types
**File**: [src/lib/projections/types.ts](src/lib/projections/types.ts)

Add after line 6 (after TaxCategory):

```typescript
/**
 * Type of income stream
 */
export type IncomeStreamType =
  | 'social_security'
  | 'pension'
  | 'rental'
  | 'annuity'
  | 'part_time'
  | 'other';

/**
 * Individual income stream for retirement projection
 */
export interface IncomeStream {
  id: string;
  name: string;
  type: IncomeStreamType;
  annualAmount: number;      // In today's dollars
  startAge: number;          // Age when income begins
  endAge?: number;           // Age when income ends (undefined = lifetime)
  inflationAdjusted: boolean; // Whether to apply COLA
}
```

Update `ProjectionInput` interface (replace lines 61-63):

```typescript
// Income streams (replaces socialSecurityAge/socialSecurityMonthly)
incomeStreams: IncomeStream[];
```

Update `ProjectionRequest` interface (replace lines 85-87):

```typescript
// Income streams override
incomeStreams?: IncomeStream[];
```

#### 3. Add onboarding types
**File**: [src/types/onboarding.ts](src/types/onboarding.ts)

Add type and options:

```typescript
export type IncomeStreamType =
  | 'social_security'
  | 'pension'
  | 'rental'
  | 'annuity'
  | 'part_time'
  | 'other';

export interface IncomeStream {
  id: string;
  name: string;
  type: IncomeStreamType;
  annualAmount: number;
  startAge: number;
  endAge?: number;
  inflationAdjusted: boolean;
}

export const INCOME_STREAM_TYPE_OPTIONS = [
  { value: 'social_security', label: 'Social Security' },
  { value: 'pension', label: 'Pension' },
  { value: 'rental', label: 'Rental Income' },
  { value: 'annuity', label: 'Annuity' },
  { value: 'part_time', label: 'Part-Time Work' },
  { value: 'other', label: 'Other' },
] as const;
```

#### 4. Generate database migration
Run `npm run db:generate` to create migration for the new column.

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles without errors: `npm run typecheck`
- [x] Migration generates successfully: `npm run db:generate`
- [x] No linting errors: `npm run lint`

#### Manual Verification:
- [x] Review generated migration SQL looks correct (adds `income_streams` jsonb column)

**Implementation Note**: After completing this phase and all automated verification passes, pause here for manual confirmation before proceeding to Phase 2.

---

## Phase 2: Projection Engine Modifications

### Overview
Update the projection engine to loop over multiple income streams instead of using single Social Security fields.

### Changes Required:

#### 1. Update engine.ts drawdown phase
**File**: [src/lib/projections/engine.ts](src/lib/projections/engine.ts)

Replace the Social Security calculation block (lines 158-162) with income stream loop:

```typescript
// Calculate total income from all active streams
let totalIncome = 0;
for (const stream of input.incomeStreams) {
  // Check if stream is active this year
  if (age >= stream.startAge && (stream.endAge === undefined || age <= stream.endAge)) {
    const streamInflation = stream.inflationAdjusted
      ? inflationMultiplier
      : 1;
    totalIncome += stream.annualAmount * streamInflation;
  }
}
```

Update the withdrawal calculation (line 165):

```typescript
// Net withdrawal needed from portfolio
const withdrawalNeeded = Math.max(0, expensesNeeded - totalIncome);
```

Update inflows tracking (line 182):

```typescript
inflows = totalIncome;
```

#### 2. Add helper function for income calculation (optional but cleaner)
**File**: [src/lib/projections/engine.ts](src/lib/projections/engine.ts)

Add after line 89 (after `totalBalance` function):

```typescript
/**
 * Calculate total income from all active streams for a given age
 */
function calculateTotalIncome(
  streams: IncomeStream[],
  age: number,
  inflationMultiplier: number
): number {
  return streams.reduce((total, stream) => {
    // Check if stream is active this year
    if (age >= stream.startAge && (stream.endAge === undefined || age <= stream.endAge)) {
      const streamInflation = stream.inflationAdjusted ? inflationMultiplier : 1;
      return total + stream.annualAmount * streamInflation;
    }
    return total;
  }, 0);
}
```

Then use in drawdown phase:

```typescript
const totalIncome = calculateTotalIncome(input.incomeStreams, age, inflationMultiplier);
```

#### 3. Update type import
**File**: [src/lib/projections/engine.ts](src/lib/projections/engine.ts)

Update imports (line 1-7) to include `IncomeStream`:

```typescript
import type {
  ProjectionInput,
  ProjectionRecord,
  ProjectionResult,
  BalanceByType,
  WithdrawalResult,
  IncomeStream,
} from './types';
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [x] Existing engine tests pass: `npm test -- --run src/lib/projections/__tests__/engine.test.ts`
- [x] No linting errors: `npm run lint`

#### Manual Verification:
- [x] Review the income calculation logic handles edge cases (no streams, overlapping streams, etc.)

**Implementation Note**: After completing this phase, pause for confirmation before proceeding to Phase 3.

---

## Phase 3: API Route Updates with Backward Compatibility

### Overview
Update the projection API to read income streams from the database and convert legacy Social Security data at read time.

### Changes Required:

#### 1. Update API route to handle income streams
**File**: [src/app/api/projections/calculate/route.ts](src/app/api/projections/calculate/route.ts)

Add import for IncomeStream type (around line 21):

```typescript
import { ACCOUNT_TAX_CATEGORY, type BalanceByType, type ProjectionInput, type IncomeStream } from '@/lib/projections/types';
```

Add import for IncomeStreamJson (line 23):

```typescript
import type { InvestmentAccountJson, DebtJson, IncomeExpensesJson, IncomeStreamJson } from '@/db/schema/financial-snapshot';
```

Add helper function to build income streams with backward compatibility (after line 25):

```typescript
/**
 * Build income streams from snapshot with backward compatibility
 * If incomeStreams exists, use it. Otherwise, generate SS stream from legacy fields.
 */
function buildIncomeStreams(
  snapshot: {
    incomeStreams?: IncomeStreamJson[] | null;
    annualIncome: string;
  },
  overrides?: {
    incomeStreams?: IncomeStream[];
    socialSecurityAge?: number;
    socialSecurityMonthly?: number;
  }
): IncomeStream[] {
  // If overrides provide income streams, use those
  if (overrides?.incomeStreams && overrides.incomeStreams.length > 0) {
    return overrides.incomeStreams;
  }

  // If snapshot has income streams, use those
  if (snapshot.incomeStreams && snapshot.incomeStreams.length > 0) {
    return snapshot.incomeStreams;
  }

  // Backward compatibility: generate Social Security stream from legacy approach
  const ssAge = overrides?.socialSecurityAge ?? DEFAULT_SS_AGE;
  const ssMonthly = overrides?.socialSecurityMonthly ??
    estimateSocialSecurityMonthly(parseFloat(snapshot.annualIncome));

  if (ssMonthly <= 0) {
    return [];
  }

  return [{
    id: 'ss-auto',
    name: 'Social Security',
    type: 'social_security' as const,
    annualAmount: ssMonthly * 12,
    startAge: ssAge,
    endAge: undefined,
    inflationAdjusted: true,
  }];
}
```

Update `calculateProjection` function to use new helper (replace lines 111-113):

```typescript
// Build income streams with backward compatibility
const incomeStreams = buildIncomeStreams(snapshot, overrides);
```

Update `projectionInput` construction to use `incomeStreams` instead of legacy fields:

```typescript
const projectionInput: ProjectionInput = {
  currentAge,
  retirementAge,
  maxAge: (overrides.maxAge as number) ?? DEFAULT_MAX_AGE,
  balancesByType,
  annualContribution,
  contributionAllocation: (overrides.contributionAllocation as BalanceByType) ?? DEFAULT_CONTRIBUTION_ALLOCATION,
  expectedReturn: (overrides.expectedReturn as number) ?? DEFAULT_RETURN_RATES[riskTolerance],
  inflationRate: (overrides.inflationRate as number) ?? DEFAULT_INFLATION_RATE,
  contributionGrowthRate: (overrides.contributionGrowthRate as number) ?? DEFAULT_CONTRIBUTION_GROWTH_RATE,
  annualExpenses,
  annualHealthcareCosts,
  healthcareInflationRate: (overrides.healthcareInflationRate as number) ?? DEFAULT_HEALTHCARE_INFLATION_RATE,
  incomeStreams, // New: replaces socialSecurityAge/socialSecurityMonthly
  annualDebtPayments,
};
```

Update response `inputs` section to include income streams info:

```typescript
inputs: {
  currentAge,
  retirementAge: projectionInput.retirementAge,
  maxAge: projectionInput.maxAge,
  expectedReturn: projectionInput.expectedReturn,
  inflationRate: projectionInput.inflationRate,
  contributionGrowthRate: projectionInput.contributionGrowthRate,
  incomeStreams: projectionInput.incomeStreams, // New field
  // Derived values for transparency
  annualExpenses,
  annualDebtPayments,
  annualContribution,
  startingBalancesByType: balancesByType,
},
```

#### 2. Update validation schema
**File**: [src/lib/validation/projections.ts](src/lib/validation/projections.ts)

Add income stream schema and update request schema:

```typescript
import { z } from 'zod';

// Income stream validation
export const incomeStreamSchema = z.object({
  id: z.string().min(1),
  name: z.string().min(1, 'Income stream name is required'),
  type: z.enum(['social_security', 'pension', 'rental', 'annuity', 'part_time', 'other']),
  annualAmount: z.number().min(0, 'Amount cannot be negative'),
  startAge: z.number().min(0).max(120),
  endAge: z.number().min(0).max(120).optional(),
  inflationAdjusted: z.boolean(),
});

// Existing contribution allocation schema...

export const projectionRequestSchema = z.object({
  expectedReturn: z.number().min(0).max(1).optional(),
  inflationRate: z.number().min(0).max(0.2).optional(),
  maxAge: z.number().min(65).max(120).optional(),
  contributionGrowthRate: z.number().min(-0.1).max(0.2).optional(),

  // Legacy SS fields (still supported for backward compatibility)
  socialSecurityAge: z.number().min(62).max(70).optional(),
  socialSecurityMonthly: z.number().min(0).optional(),

  // New income streams field
  incomeStreams: z.array(incomeStreamSchema).optional(),

  annualHealthcareCosts: z.number().min(0).optional(),
  healthcareInflationRate: z.number().min(0).max(0.15).optional(),
  contributionAllocation: contributionAllocationSchema.optional(),
});
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [x] API route tests pass: `npm test -- --run src/app/api/projections/calculate/route.test.ts`
- [x] All projection tests pass: `npm test -- --run src/lib/projections`
- [x] No linting errors: `npm run lint`

#### Manual Verification:
- [ ] API returns correct results for users without `incomeStreams` (backward compat)
- [ ] API accepts `incomeStreams` override in POST request

**Implementation Note**: After completing this phase, pause for confirmation before proceeding to Phase 4.

---

## Phase 4: Onboarding UI for Income Streams

### Overview
Add a new onboarding step or extend an existing step to collect income stream data from users.

### Changes Required:

#### 1. Add income streams validation schema
**File**: [src/lib/validation/onboarding.ts](src/lib/validation/onboarding.ts)

Add schema for income streams:

```typescript
// Income stream schema
export const incomeStreamSchema = z.object({
  id: z.string().min(1),
  name: z.string().min(1, 'Name is required'),
  type: z.enum(['social_security', 'pension', 'rental', 'annuity', 'part_time', 'other']),
  annualAmount: z.number().min(0, 'Amount cannot be negative'),
  startAge: z.number().min(50, 'Start age must be at least 50').max(90, 'Start age must be 90 or less'),
  endAge: z.number().min(50).max(120).optional(),
  inflationAdjusted: z.boolean(),
});

export const stepIncomeStreamsSchema = z.object({
  incomeStreams: z.array(incomeStreamSchema),
});

export type OnboardingStepIncomeStreamsData = z.infer<typeof stepIncomeStreamsSchema>;
```

Update `completeOnboardingSchemaV2` to include income streams.

#### 2. Create IncomeStreamsStep component
**File**: `src/components/onboarding/step-income-streams.tsx` (new file)

```typescript
'use client';

import { useForm, useFieldArray, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { Plus, Trash2 } from 'lucide-react';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card';
import { Select, SelectContent, SelectItem, SelectTrigger, SelectValue } from '@/components/ui/select';
import { Checkbox } from '@/components/ui/checkbox';
import { stepIncomeStreamsSchema, type OnboardingStepIncomeStreamsData } from '@/lib/validation/onboarding';
import { INCOME_STREAM_TYPE_OPTIONS } from '@/types/onboarding';

interface StepIncomeStreamsProps {
  onNext: (data: OnboardingStepIncomeStreamsData) => void;
  onBack: () => void;
  initialData?: Partial<OnboardingStepIncomeStreamsData>;
}

export function StepIncomeStreams({ onNext, onBack, initialData }: StepIncomeStreamsProps) {
  const {
    register,
    control,
    handleSubmit,
    formState: { errors },
  } = useForm<OnboardingStepIncomeStreamsData>({
    resolver: zodResolver(stepIncomeStreamsSchema),
    defaultValues: {
      incomeStreams: initialData?.incomeStreams || [],
    },
  });

  const { fields, append, remove } = useFieldArray({
    control,
    name: 'incomeStreams',
  });

  const addIncomeStream = () => {
    append({
      id: crypto.randomUUID(),
      name: '',
      type: 'social_security',
      annualAmount: 0,
      startAge: 67,
      endAge: undefined,
      inflationAdjusted: true,
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Expected Retirement Income</CardTitle>
        <CardDescription>
          Add any income sources you expect during retirement (Social Security, pensions, rental income, etc.)
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onNext)} className="space-y-6">
          {fields.length === 0 && (
            <p className="text-sm text-muted-foreground text-center py-4">
              No income sources added yet. Click below to add your first income source.
            </p>
          )}

          {fields.map((field, index) => (
            <div key={field.id} className="space-y-4 p-4 border rounded-lg relative">
              <button
                type="button"
                onClick={() => remove(index)}
                className="absolute top-2 right-2 text-muted-foreground hover:text-red-500"
                aria-label="Remove income source"
              >
                <Trash2 className="h-4 w-4" />
              </button>

              <div className="grid grid-cols-2 gap-4">
                <div className="space-y-2">
                  <Label htmlFor={`incomeStreams.${index}.name`}>Name</Label>
                  <Input
                    id={`incomeStreams.${index}.name`}
                    placeholder="e.g., Social Security"
                    {...register(`incomeStreams.${index}.name`)}
                  />
                  {errors.incomeStreams?.[index]?.name && (
                    <p className="text-sm text-red-500">
                      {errors.incomeStreams[index]?.name?.message}
                    </p>
                  )}
                </div>

                <div className="space-y-2">
                  <Label htmlFor={`incomeStreams.${index}.type`}>Type</Label>
                  <Controller
                    name={`incomeStreams.${index}.type`}
                    control={control}
                    render={({ field }) => (
                      <Select value={field.value} onValueChange={field.onChange}>
                        <SelectTrigger>
                          <SelectValue placeholder="Select type" />
                        </SelectTrigger>
                        <SelectContent>
                          {INCOME_STREAM_TYPE_OPTIONS.map((option) => (
                            <SelectItem key={option.value} value={option.value}>
                              {option.label}
                            </SelectItem>
                          ))}
                        </SelectContent>
                      </Select>
                    )}
                  />
                </div>
              </div>

              <div className="grid grid-cols-3 gap-4">
                <div className="space-y-2">
                  <Label htmlFor={`incomeStreams.${index}.annualAmount`}>Annual Amount ($)</Label>
                  <Input
                    id={`incomeStreams.${index}.annualAmount`}
                    type="number"
                    placeholder="24000"
                    {...register(`incomeStreams.${index}.annualAmount`, { valueAsNumber: true })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor={`incomeStreams.${index}.startAge`}>Start Age</Label>
                  <Input
                    id={`incomeStreams.${index}.startAge`}
                    type="number"
                    placeholder="67"
                    {...register(`incomeStreams.${index}.startAge`, { valueAsNumber: true })}
                  />
                </div>

                <div className="space-y-2">
                  <Label htmlFor={`incomeStreams.${index}.endAge`}>End Age (optional)</Label>
                  <Input
                    id={`incomeStreams.${index}.endAge`}
                    type="number"
                    placeholder="Lifetime"
                    {...register(`incomeStreams.${index}.endAge`, { valueAsNumber: true })}
                  />
                </div>
              </div>

              <div className="flex items-center space-x-2">
                <Controller
                  name={`incomeStreams.${index}.inflationAdjusted`}
                  control={control}
                  render={({ field }) => (
                    <Checkbox
                      id={`incomeStreams.${index}.inflationAdjusted`}
                      checked={field.value}
                      onCheckedChange={field.onChange}
                    />
                  )}
                />
                <Label
                  htmlFor={`incomeStreams.${index}.inflationAdjusted`}
                  className="text-sm font-normal cursor-pointer"
                >
                  Adjusts for inflation (COLA)
                </Label>
              </div>
            </div>
          ))}

          <Button type="button" variant="outline" onClick={addIncomeStream} className="w-full">
            <Plus className="h-4 w-4 mr-2" />
            Add Income Source
          </Button>

          <div className="flex gap-3">
            <Button type="button" variant="outline" onClick={onBack} className="flex-1">
              Back
            </Button>
            <Button type="submit" className="flex-1">
              Continue
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

#### 3. Add step to onboarding flow
**File**: [src/app/onboarding/page.tsx](src/app/onboarding/page.tsx)

Add new step to wizard:

```typescript
// Add to WizardStep type
type WizardStep =
  | 'smart-intake'
  | 'basics'
  | 'retirement'
  | 'income-savings'
  | 'savings-accounts'
  | 'expenses'
  | 'income-streams'  // NEW
  | 'assets-debts'
  | 'risk'
  | 'review';

// Add to STEP_ORDER array (after 'expenses')
const STEP_ORDER: WizardStep[] = [
  'smart-intake',
  'basics',
  'retirement',
  'income-savings',
  'savings-accounts',
  'expenses',
  'income-streams',  // NEW
  'assets-debts',
  'risk',
  'review',
];

// Add to STEP_LABELS
const STEP_LABELS: Record<WizardStep, string> = {
  // ... existing labels
  'income-streams': 'Retirement Income',  // NEW
  // ... rest of labels
};
```

Add rendering for the new step in the render switch:

```typescript
{currentStep === 'income-streams' && (
  <StepIncomeStreams
    onNext={handleStepComplete}
    onBack={goBack}
    initialData={formData}
  />
)}
```

#### 4. Update onboarding completion API
**File**: [src/app/api/onboarding/complete/route.ts](src/app/api/onboarding/complete/route.ts)

Add income streams to the database insert:

```typescript
await db.insert(financialSnapshot).values({
  // ... existing fields
  incomeStreams: data.incomeStreams || [],  // NEW
});
```

#### 5. Export new component
**File**: [src/components/onboarding/index.ts](src/components/onboarding/index.ts)

Add export:

```typescript
export { StepIncomeStreams } from './step-income-streams';
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `npm run typecheck`
- [ ] Build succeeds: `npm run build`
- [ ] No linting errors: `npm run lint`

#### Manual Verification:
- [ ] Navigate through onboarding and add income streams
- [ ] Verify income streams are saved to database
- [ ] Complete onboarding and verify projection uses new income streams

**Implementation Note**: After completing this phase, pause for confirmation before proceeding to Phase 5.

---

## Phase 5: Profile UI for Editing Income Streams

### Overview
Add income streams section to the profile page so users can view and edit their retirement income sources after onboarding.

### Changes Required:

#### 1. Update ProfileData interface
**File**: [src/app/profile/profile-client.tsx](src/app/profile/profile-client.tsx)

Add income streams to the ProfileData interface (around line 24):

```typescript
export interface ProfileData {
  birthYear: number;
  targetRetirementAge: number;
  filingStatus: FilingStatus;
  annualIncome: number;
  savingsRate: number;
  riskTolerance: RiskTolerance;
  investmentAccounts: InvestmentAccountJson[];
  primaryResidence: PrimaryResidenceJson | null;
  debts: DebtJson[];
  incomeExpenses: IncomeExpensesJson | null;
  incomeStreams: IncomeStreamJson[];  // NEW
}
```

Add import for IncomeStreamJson:

```typescript
import type {
  InvestmentAccountJson,
  PrimaryResidenceJson,
  DebtJson,
  IncomeExpensesJson,
  IncomeStreamJson,  // NEW
} from '@/db/schema/financial-snapshot';
```

#### 2. Add 'income-streams' to EditSection type
**File**: [src/app/profile/profile-client.tsx](src/app/profile/profile-client.tsx)

Update EditSection type (around line 37):

```typescript
type EditSection =
  | 'basics'
  | 'retirement'
  | 'income'
  | 'risk'
  | 'savings'
  | 'expenses'
  | 'income-streams'  // NEW
  | 'assets'
  | null;
```

#### 3. Add Retirement Income section to profile display
**File**: [src/app/profile/profile-client.tsx](src/app/profile/profile-client.tsx)

Add new Collapsible section after Monthly Expenses section (around line 288):

```typescript
{/* Retirement Income Section */}
<Collapsible
  title="Retirement Income"
  defaultOpen
  onEdit={() => setEditSection('income-streams')}
>
  {profileData.incomeStreams && profileData.incomeStreams.length > 0 ? (
    <div className="space-y-3">
      {profileData.incomeStreams.map((stream) => (
        <div key={stream.id} className="flex justify-between text-sm border-b pb-2 last:border-0">
          <div>
            <span className="font-medium">{stream.name}</span>
            <span className="text-muted-foreground ml-2">
              ({stream.type.replace('_', ' ')})
            </span>
            <div className="text-muted-foreground text-xs">
              Age {stream.startAge}{stream.endAge ? ` - ${stream.endAge}` : '+'}
              {stream.inflationAdjusted && ' • Inflation adjusted'}
            </div>
          </div>
          <div className="text-right">
            <div>{formatCurrency(stream.annualAmount)}/yr</div>
          </div>
        </div>
      ))}
      {/* Total income summary */}
      {(() => {
        const totalAnnualIncome = profileData.incomeStreams.reduce(
          (sum, stream) => sum + stream.annualAmount,
          0
        );
        return (
          <div className="flex justify-between pt-2 font-medium border-t">
            <span>Total Annual Income</span>
            <span>{formatCurrency(totalAnnualIncome)}</span>
          </div>
        );
      })()}
    </div>
  ) : (
    <p className="text-sm text-muted-foreground">No retirement income sources added.</p>
  )}
</Collapsible>
```

#### 4. Add edit dialog for income streams
**File**: [src/app/profile/profile-client.tsx](src/app/profile/profile-client.tsx)

Add import for StepIncomeStreams:

```typescript
import { StepIncomeStreams } from '@/components/onboarding/step-income-streams';
```

Add dialog after the assets dialog (around line 432):

```typescript
<Dialog open={editSection === 'income-streams'} onOpenChange={handleEditClose}>
  <DialogContent className="max-w-2xl">
    <DialogHeader>
      <DialogTitle>Edit Retirement Income</DialogTitle>
    </DialogHeader>
    <StepIncomeStreams
      onNext={(data) => handleEditSave(data)}
      onBack={handleEditClose}
      initialData={formData}
      submitLabel="Save"
      cancelLabel="Cancel"
    />
  </DialogContent>
</Dialog>
```

#### 5. Update StepIncomeStreams to support profile editing props
**File**: [src/components/onboarding/step-income-streams.tsx](src/components/onboarding/step-income-streams.tsx)

Update props interface to match other step components:

```typescript
interface StepIncomeStreamsProps {
  onNext: (data: OnboardingStepIncomeStreamsData) => void;
  onBack: () => void;
  initialData?: Partial<OnboardingStepIncomeStreamsData>;
  submitLabel?: string;   // NEW - for profile editing
  cancelLabel?: string;   // NEW - for profile editing
}

export function StepIncomeStreams({
  onNext,
  onBack,
  initialData,
  submitLabel = 'Continue',
  cancelLabel = 'Back',
}: StepIncomeStreamsProps) {
  // ... existing implementation

  // Update button labels:
  <div className="flex gap-3">
    <Button type="button" variant="outline" onClick={onBack} className="flex-1">
      {cancelLabel}
    </Button>
    <Button type="submit" className="flex-1">
      {submitLabel}
    </Button>
  </div>
}
```

#### 6. Update profile API to handle income streams
**File**: [src/app/api/profile/route.ts](src/app/api/profile/route.ts)

Add income streams handling to the update logic (around line 66):

```typescript
// JSONB fields
if (data.investmentAccounts !== undefined) {
  updateData.investmentAccounts = data.investmentAccounts;
}
if (data.primaryResidence !== undefined) {
  updateData.primaryResidence = data.primaryResidence;
}
if (data.debts !== undefined) {
  updateData.debts = data.debts;
}
if (data.incomeExpenses !== undefined) {
  updateData.incomeExpenses = data.incomeExpenses;
}
if (data.incomeStreams !== undefined) {  // NEW
  updateData.incomeStreams = data.incomeStreams;
}
```

#### 7. Update profile validation schema
**File**: [src/lib/validation/profile.ts](src/lib/validation/profile.ts)

Add income streams schema to the merge:

```typescript
import {
  step1Schema,
  step2Schema,
  step3Schema,
  step4Schema,
  step2SavingsSchema,
  step3IncomeExpensesSchema,
  step4AssetsDebtsSchema,
  stepIncomeStreamsSchema,  // NEW
} from './onboarding';

// Partial schema for profile updates - all fields optional
export const profileUpdateSchema = step1Schema
  .merge(step2Schema)
  .merge(step3Schema)
  .merge(step4Schema)
  .merge(step2SavingsSchema)
  .merge(step3IncomeExpensesSchema)
  .merge(step4AssetsDebtsSchema)
  .merge(stepIncomeStreamsSchema)  // NEW
  .partial();
```

#### 8. Update profile page server component
**File**: [src/app/profile/page.tsx](src/app/profile/page.tsx)

Ensure income streams are fetched from the database and passed to ProfileClient:

```typescript
// When fetching snapshot, ensure incomeStreams is included
const profileData: ProfileData = {
  // ... existing fields
  incomeStreams: snapshot.incomeStreams || [],  // NEW
};
```

### Success Criteria:

#### Automated Verification:
- [ ] TypeScript compiles: `npm run typecheck`
- [ ] Build succeeds: `npm run build`
- [ ] No linting errors: `npm run lint`

#### Manual Verification:
- [ ] Profile page displays "Retirement Income" section
- [ ] Empty state shows "No retirement income sources added"
- [ ] Existing income streams display with name, type, ages, and amount
- [ ] Total annual income calculates correctly
- [ ] Edit button opens dialog with StepIncomeStreams component
- [ ] Save updates income streams in database
- [ ] Cancel closes dialog without changes

**Implementation Note**: After completing this phase, pause for confirmation before proceeding to Phase 6.

---

## Phase 6: Tests

### Overview
Add comprehensive tests for the new income streams functionality.

### Changes Required:

#### 1. Update engine tests
**File**: [src/lib/projections/__tests__/engine.test.ts](src/lib/projections/__tests__/engine.test.ts)

Add test cases for multiple income streams:

```typescript
describe('multiple income streams', () => {
  const baseInput: ProjectionInput = {
    currentAge: 65,
    retirementAge: 65,
    maxAge: 70,
    balancesByType: { taxDeferred: 500000, taxFree: 0, taxable: 0 },
    annualContribution: 0,
    contributionAllocation: { taxDeferred: 100, taxFree: 0, taxable: 0 },
    expectedReturn: 0.05,
    inflationRate: 0.025,
    contributionGrowthRate: 0,
    annualExpenses: 50000,
    annualHealthcareCosts: 5000,
    healthcareInflationRate: 0.05,
    incomeStreams: [],
    annualDebtPayments: 0,
  };

  it('should handle zero income streams', () => {
    const result = runProjection(baseInput);
    // All expenses come from withdrawals
    expect(result.records[0].outflows).toBeGreaterThan(0);
    expect(result.records[0].inflows).toBe(0);
  });

  it('should sum multiple income streams', () => {
    const input: ProjectionInput = {
      ...baseInput,
      incomeStreams: [
        {
          id: 'ss',
          name: 'Social Security',
          type: 'social_security',
          annualAmount: 24000,
          startAge: 65,
          inflationAdjusted: true,
        },
        {
          id: 'pension',
          name: 'Pension',
          type: 'pension',
          annualAmount: 12000,
          startAge: 65,
          inflationAdjusted: false,
        },
      ],
    };

    const result = runProjection(input);
    // First year: SS + Pension = 36000 inflows
    expect(result.records[0].inflows).toBe(36000);
  });

  it('should activate streams at start age', () => {
    const input: ProjectionInput = {
      ...baseInput,
      incomeStreams: [
        {
          id: 'ss',
          name: 'Social Security',
          type: 'social_security',
          annualAmount: 24000,
          startAge: 67,
          inflationAdjusted: true,
        },
      ],
    };

    const result = runProjection(input);
    // Age 65-66: no income
    expect(result.records[0].inflows).toBe(0);
    expect(result.records[1].inflows).toBe(0);
    // Age 67+: SS starts
    expect(result.records[2].inflows).toBeGreaterThan(0);
  });

  it('should deactivate streams at end age', () => {
    const input: ProjectionInput = {
      ...baseInput,
      incomeStreams: [
        {
          id: 'part-time',
          name: 'Part-time Work',
          type: 'part_time',
          annualAmount: 20000,
          startAge: 65,
          endAge: 67,
          inflationAdjusted: false,
        },
      ],
    };

    const result = runProjection(input);
    // Age 65-67: income active
    expect(result.records[0].inflows).toBe(20000);
    expect(result.records[1].inflows).toBe(20000);
    expect(result.records[2].inflows).toBe(20000);
    // Age 68+: income stopped
    expect(result.records[3].inflows).toBe(0);
  });

  it('should apply inflation to adjusted streams only', () => {
    const input: ProjectionInput = {
      ...baseInput,
      inflationRate: 0.10, // 10% for easy math
      incomeStreams: [
        {
          id: 'ss',
          name: 'Social Security',
          type: 'social_security',
          annualAmount: 10000,
          startAge: 65,
          inflationAdjusted: true,
        },
        {
          id: 'pension',
          name: 'Pension',
          type: 'pension',
          annualAmount: 10000,
          startAge: 65,
          inflationAdjusted: false,
        },
      ],
    };

    const result = runProjection(input);
    // Year 1: 10000 + 10000 = 20000
    expect(result.records[0].inflows).toBe(20000);
    // Year 2: 11000 (SS inflated) + 10000 (pension fixed) = 21000
    expect(result.records[1].inflows).toBe(21000);
  });
});
```

#### 2. Add API route tests
**File**: [src/app/api/projections/calculate/route.test.ts](src/app/api/projections/calculate/route.test.ts)

Add tests for backward compatibility and income streams:

```typescript
describe('income streams', () => {
  it('should build SS stream from legacy data when incomeStreams is empty', async () => {
    // Mock snapshot without incomeStreams
    // Verify projection uses auto-generated SS stream
  });

  it('should use incomeStreams from snapshot when present', async () => {
    // Mock snapshot with incomeStreams
    // Verify projection uses stored streams
  });

  it('should accept incomeStreams override in POST request', async () => {
    // POST with incomeStreams override
    // Verify override is used
  });
});
```

### Success Criteria:

#### Automated Verification:
- [ ] All engine tests pass: `npm test -- --run src/lib/projections/__tests__/engine.test.ts`
- [ ] All API tests pass: `npm test -- --run src/app/api/projections`
- [ ] Full test suite passes: `npm test`
- [ ] No linting errors: `npm run lint`

#### Manual Verification:
- [ ] Review test coverage for edge cases

---

## Testing Strategy

### Unit Tests:
- Engine correctly sums multiple income streams
- Engine handles empty income streams array
- Engine activates/deactivates streams at correct ages
- Engine applies inflation only to flagged streams
- Backward compatibility generates SS stream correctly

### Integration Tests:
- API returns correct projection with income streams from DB
- API handles legacy users (no incomeStreams column)
- Onboarding saves income streams correctly

### Manual Testing Steps:
1. Complete onboarding with 0 income streams - verify projection works
2. Complete onboarding with 1 Social Security stream - verify matches legacy behavior
3. Complete onboarding with multiple streams at different start ages - verify each activates correctly
4. Add part-time work stream with end age - verify it deactivates
5. Mix inflation-adjusted and fixed streams - verify inflation applies correctly
6. View income streams on profile page - verify display is correct
7. Edit income streams from profile page - verify changes are saved and projection updates

## Performance Considerations

- Income stream calculation adds O(n) loop per year where n = number of streams
- Typical user has 1-5 income streams, so negligible performance impact
- No database query changes (incomeStreams loaded with existing snapshot query)

## Migration Notes

- No database migration for existing data required
- Backward compatibility handled at read time via `buildIncomeStreams()` helper
- Existing users continue to work with auto-generated SS stream

## References

- Original ticket: [thoughts/personal/tickets/epic-3/projection-modeling/story-4-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-4-scope.md)
- Research document: [thoughts/shared/research/2025-12-26-story-3.4-multiple-income-expense-streams-research.md](thoughts/shared/research/2025-12-26-story-3.4-multiple-income-expense-streams-research.md)
- Story 3.1 engine implementation: [thoughts/shared/plans/2025-12-18-epic-3-story-1-projection-engine.md](thoughts/shared/plans/2025-12-18-epic-3-story-1-projection-engine.md)
