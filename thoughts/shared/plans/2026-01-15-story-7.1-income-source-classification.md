# Story 7.1 â€“ Income Source Classification Implementation Plan

## Overview

Extend the existing Step 3 (Income & Savings) of the onboarding flow to capture income source classification. Users will describe how they earn their income using real-world categories, enabling the system to understand their tax exposure and planning flexibility.

## Current State Analysis

### Existing Step 3 Implementation
- **File**: `src/components/onboarding/step3-financial-info.tsx`
- **Current fields**: `annualIncome`, `savingsRate`
- **Data type**: `OnboardingStep3Data` in `src/types/onboarding.ts:70-73`
- **Validation**: `step3Schema` in `src/lib/validation/onboarding.ts:30-39`

### Database Storage
- **Table**: `financial_snapshot` (`src/db/schema/financial-snapshot.ts`)
- **Current income field**: `annualIncome` (numeric column)
- **Pattern for complex data**: JSONB columns (e.g., `incomeStreams`, `investmentAccounts`)

## Desired End State

After implementation:
1. Step 3 collects annual income, savings rate, AND income source classification
2. Users can select multiple income types with amounts for each
3. Each income source has variability (recurring/variable/seasonal) and auto-populated tax flexibility flags
4. Data is stored in a new `income_sources` JSONB column
5. The sum of income sources equals the total annual income (validated)
6. Profile page displays income sources breakdown
7. Projection engine uses aggregated income sources (with backward compatibility)

### Verification
- [ ] New onboarding users can classify their income sources
- [ ] Total income from sources matches stated annual income
- [ ] Income sources are visible on the profile page
- [ ] Projections work correctly with income source data
- [ ] Existing users without income sources still work (backward compatible)

## What We're NOT Doing

- **NOT** creating a separate onboarding step (merging into Step 3)
- **NOT** implementing actual tax calculations (that's a later story)
- **NOT** adding income verification/account linking
- **NOT** capturing multi-year income history
- **NOT** requiring users to fill in flexibility details (auto-populated from type)
- **NOT** breaking existing projections for users without income sources
- **NOT** unifying rental income across working-age and retirement contexts
- **NOT** adding detailed entity structure options (LLC vs S-Corp vs C-Corp)

## Design Decisions (Resolved Open Questions)

### 1. Rental Income: Keep Separate from Retirement Income Streams

**Decision:** Maintain separate models for working-age (`IncomeSource`) and retirement (`IncomeStream`) rental income.

| Context | Type | Purpose | Key Attributes |
|---------|------|---------|----------------|
| Working-age | `IncomeSource` with `rental_income` | Tax classification, current income | `variability`, `flexibility` |
| Retirement | `IncomeStream` with `rental` | Cash flow projection | `startAge`, `endAge`, `inflationAdjusted` |

**Rationale:**
- Different lifecycle phases with non-overlapping age constraints (`IncomeStream` requires `startAge >= 50`)
- Different attributes needed for each context
- Codebase has 5 explicit comments maintaining property/income separation
- No migration or unification complexity

**UX Guidance:** Add helper text: *"If you have rental income, add it here for your current tax picture. You can also add it as a retirement income stream later if you expect it to continue."*

---

### 2. Tax Flexibility: 3 Boolean Flags, Auto-Populated, Read-Only

**Decision:** Use simple boolean flags that are automatically set based on income type and displayed as informational badges.

```typescript
flexibility: {
  canDefer: boolean;      // Can defer income to future years
  canReduce: boolean;     // Can reduce through deductions/expenses
  canRestructure: boolean; // Can change entity structure
}
```

**Rationale:**
- Simpler UX: Users don't need to understand tax nuances
- Auto-populated based on income type selection
- Displayed as read-only badges ("Deferrable", "Deductible", "Restructurable")
- Future extensibility: Can add percentage fields later if needed

**NOT doing:** Percentage-based flexibility inputs, user-editable flexibility flags.

---

### 3. Business Entity Structure: Single "Business Owner" Option

**Decision:** Keep a single "Business Owner (LLC / S-Corp)" option with optional notes field for specifics.

**Rationale:**
- Story 7.1 scope is income classification, not entity optimization
- LLC vs S-Corp vs C-Corp distinctions primarily matter for tax optimization (future story)
- The `notes` field allows users to specify entity type if desired
- Avoids additional UI complexity and decision fatigue

**NOT doing:** Separate dropdown for LLC, S-Corp, C-Corp, Partnership, Sole Prop distinctions.

---

### 4. Income Verification: Out of Scope

**Decision:** No income verification or account linking in this story.

**Rationale:**
- Would require significant infrastructure (Plaid integration)
- Privacy concerns for many users
- The app operates on self-reported data throughout
- Not required for tax classification purposes

**NOT doing:** Account linking, income verification, document upload, bank statement parsing.

---

### 5. Multi-Year Income History: Out of Scope

**Decision:** Capture current-year income only. Schema designed for future extensibility.

**Rationale:**
- Story requirement is "describe how they make money" (present tense)
- Historical data would require complex year-by-year UI
- The `IncomeSource` schema can be extended later if needed:
  ```typescript
  historicalAmounts?: { year: number; amount: number }[];
  ```

**NOT doing:** Historical income tracking, trend analysis, year-over-year comparisons.

## Implementation Approach

Extend Step 3 into a two-part form:
1. **Part 1**: Total annual income and savings rate (existing)
2. **Part 2**: Income source breakdown (new) - multi-select cards with amounts

The income sources must sum to the total annual income for validation.

---

## Phase 1: Type Definitions & Validation

### Overview
Create the foundational type definitions and validation schemas for income sources.

### Changes Required:

#### 1. New Type Definitions
**File**: `src/types/income-sources.ts` (NEW)

```typescript
// Income source categories (tax-relevant classification)
export type IncomeSourceType =
  | 'w2_employment'
  | 'self_employed'
  | 'business_owner'
  | 'contract_1099'
  | 'rental_income'
  | 'investment_income';

// Income variability
export type IncomeVariability = 'recurring' | 'variable' | 'seasonal';

// Tax flexibility (auto-populated based on income type)
export interface TaxFlexibility {
  canDefer: boolean;      // Can defer income to future years
  canReduce: boolean;     // Can reduce through deductions/expenses
  canRestructure: boolean; // Can change entity structure
}

// Complete income source model
export interface IncomeSource {
  id: string;
  type: IncomeSourceType;
  label: string;                    // User-friendly display name
  annualAmount: number;
  variability: IncomeVariability;
  flexibility: TaxFlexibility;
  isPrimary: boolean;               // Primary income source flag
  notes?: string;                   // Optional user notes
}

// UI option definitions with plain-language descriptions
export const INCOME_SOURCE_OPTIONS: Array<{
  value: IncomeSourceType;
  label: string;
  description: string;
  defaultFlexibility: TaxFlexibility;
}> = [
  {
    value: 'w2_employment',
    label: 'W-2 Employment',
    description: 'Regular job with taxes withheld from paycheck',
    defaultFlexibility: { canDefer: false, canReduce: false, canRestructure: false }
  },
  {
    value: 'self_employed',
    label: 'Self-Employed / Sole Proprietor',
    description: 'Freelance work or own business without formal entity',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: true }
  },
  {
    value: 'business_owner',
    label: 'Business Owner (LLC / S-Corp)',
    description: 'Own a business through a formal legal entity',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: true }
  },
  {
    value: 'contract_1099',
    label: 'Contract / 1099 Work',
    description: 'Independent contractor or consulting work',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: false }
  },
  {
    value: 'rental_income',
    label: 'Rental Income',
    description: 'Income from renting out property',
    defaultFlexibility: { canDefer: false, canReduce: true, canRestructure: false }
  },
  {
    value: 'investment_income',
    label: 'Investment Income',
    description: 'Dividends, interest, or capital gains',
    defaultFlexibility: { canDefer: true, canReduce: false, canRestructure: false }
  }
];

export const INCOME_VARIABILITY_OPTIONS = [
  { value: 'recurring', label: 'Recurring', description: 'Predictable, consistent income' },
  { value: 'variable', label: 'Variable', description: 'Amount changes month to month' },
  { value: 'seasonal', label: 'Seasonal', description: 'Income concentrated in certain periods' },
] as const;

// Helper to get default flexibility for an income type
export function getDefaultFlexibility(type: IncomeSourceType): TaxFlexibility {
  const option = INCOME_SOURCE_OPTIONS.find(o => o.value === type);
  return option?.defaultFlexibility ?? { canDefer: false, canReduce: false, canRestructure: false };
}
```

#### 2. Update Onboarding Types
**File**: `src/types/onboarding.ts`

Add import and extend `OnboardingStep3Data`:

```typescript
// At top of file, add import
import type { IncomeSource } from './income-sources';

// Update OnboardingStep3Data (lines 70-73)
export interface OnboardingStep3Data {
  annualIncome: number;
  savingsRate: number;
  incomeSources?: IncomeSource[];  // NEW: Optional for backward compatibility
}
```

Also add re-export:
```typescript
// Re-export income source types
export * from './income-sources';
```

#### 3. Validation Schema
**File**: `src/lib/validation/income-sources.ts` (NEW)

```typescript
import { z } from 'zod';

export const incomeSourceTypeSchema = z.enum([
  'w2_employment',
  'self_employed',
  'business_owner',
  'contract_1099',
  'rental_income',
  'investment_income'
]);

export const incomeVariabilitySchema = z.enum(['recurring', 'variable', 'seasonal']);

export const taxFlexibilitySchema = z.object({
  canDefer: z.boolean(),
  canReduce: z.boolean(),
  canRestructure: z.boolean(),
});

export const incomeSourceSchema = z.object({
  id: z.string().min(1),
  type: incomeSourceTypeSchema,
  label: z.string().min(1),
  annualAmount: z.number().min(0).max(100_000_000),
  variability: incomeVariabilitySchema,
  flexibility: taxFlexibilitySchema,
  isPrimary: z.boolean(),
  notes: z.string().optional(),
});

export type IncomeSourceFormData = z.infer<typeof incomeSourceSchema>;
```

#### 4. Update Step 3 Validation
**File**: `src/lib/validation/onboarding.ts`

```typescript
// Add import at top
import { incomeSourceSchema } from './income-sources';

// Update step3Schema (lines 30-39)
export const step3Schema = z.object({
  annualIncome: z
    .number()
    .min(0, 'Annual income cannot be negative')
    .max(10000000, 'Annual income cannot exceed $10,000,000'),
  savingsRate: z
    .number()
    .min(0, 'Savings rate cannot be negative')
    .max(100, 'Savings rate cannot exceed 100%'),
  incomeSources: z.array(incomeSourceSchema).optional(),
}).refine(
  (data) => {
    // If income sources provided, they must sum to annual income (within $1 tolerance)
    if (data.incomeSources && data.incomeSources.length > 0) {
      const total = data.incomeSources.reduce((sum, s) => sum + s.annualAmount, 0);
      return Math.abs(total - data.annualIncome) <= 1;
    }
    return true;
  },
  { message: 'Income sources must add up to your total annual income', path: ['incomeSources'] }
).refine(
  (data) => {
    // If income sources provided, exactly one must be primary
    if (data.incomeSources && data.incomeSources.length > 0) {
      return data.incomeSources.filter(s => s.isPrimary).length === 1;
    }
    return true;
  },
  { message: 'Please mark one income source as your primary source', path: ['incomeSources'] }
);
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles without errors: `npm run typecheck`
- [x] Linting passes: `npm run lint`
- [ ] New validation schema tests pass (to be added)

#### Manual Verification:
- [x] Types are properly exported and can be imported in other files

---

## Phase 2: Database Schema Update

### Overview
Add the `income_sources` JSONB column to the `financial_snapshot` table.

### Changes Required:

#### 1. Update Drizzle Schema
**File**: `src/db/schema/financial-snapshot.ts`

Add new type and column:

```typescript
// Add after IncomeStreamJson type definition (around line 48)
export type IncomeSourceJson = {
  id: string;
  type: 'w2_employment' | 'self_employed' | 'business_owner' | 'contract_1099' | 'rental_income' | 'investment_income';
  label: string;
  annualAmount: number;
  variability: 'recurring' | 'variable' | 'seasonal';
  flexibility: {
    canDefer: boolean;
    canReduce: boolean;
    canRestructure: boolean;
  };
  isPrimary: boolean;
  notes?: string;
};

// Add column in financialSnapshot table definition (around line 85)
incomeSources: jsonb('income_sources').$type<IncomeSourceJson[]>(),
```

#### 2. Generate Migration
Run: `npm run db:generate`

This will create a migration file like `src/db/migrations/0008_add_income_sources.sql`:
```sql
ALTER TABLE "financial_snapshot" ADD COLUMN "income_sources" jsonb;
```

### Success Criteria:

#### Automated Verification:
- [x] Migration generates successfully: `npm run db:generate`
- [x] TypeScript compiles: `npm run typecheck`

#### Manual Verification:
- [x] Migration file is created in `src/db/migrations/`
- [ ] Migration can be applied to database without errors

**Implementation Note**: After completing this phase, apply the migration to your development database before proceeding.

---

## Phase 3: UI Implementation

### Overview
Enhance Step 3 to include income source classification with a multi-select card interface.

### Changes Required:

#### 1. Update Step 3 Component
**File**: `src/components/onboarding/step3-financial-info.tsx`

Complete rewrite to include income sources section:

```typescript
'use client';

import { useEffect, useState } from 'react';
import { useForm, useFieldArray, Controller } from 'react-hook-form';
import { zodResolver } from '@hookform/resolvers/zod';
import { nanoid } from 'nanoid';
import { Button } from '@/components/ui/button';
import { Input } from '@/components/ui/input';
import { Label } from '@/components/ui/label';
import { RadioGroup, RadioGroupItem } from '@/components/ui/radio-group';
import { Checkbox } from '@/components/ui/checkbox';
import {
  Card,
  CardContent,
  CardDescription,
  CardHeader,
  CardTitle,
} from '@/components/ui/card';
import {
  Collapsible,
  CollapsibleContent,
  CollapsibleTrigger,
} from '@/components/ui/collapsible';
import { ChevronDown, Plus, Trash2, Star } from 'lucide-react';
import { cn } from '@/lib/utils';
import { step3Schema } from '@/lib/validation/onboarding';
import type { OnboardingStep3Data } from '@/types/onboarding';
import {
  INCOME_SOURCE_OPTIONS,
  INCOME_VARIABILITY_OPTIONS,
  getDefaultFlexibility,
  type IncomeSourceType,
  type IncomeSource,
} from '@/types/income-sources';

interface Step3Props {
  onNext: (data: OnboardingStep3Data) => void;
  onBack: () => void;
  initialData?: Partial<OnboardingStep3Data>;
  submitLabel?: string;
  cancelLabel?: string;
  onChange?: () => void;
}

export function Step3FinancialInfo({
  onNext,
  onBack,
  initialData,
  submitLabel = 'Continue',
  cancelLabel = 'Back',
  onChange,
}: Step3Props) {
  const [selectedTypes, setSelectedTypes] = useState<Set<IncomeSourceType>>(
    new Set(initialData?.incomeSources?.map(s => s.type) ?? [])
  );

  const {
    register,
    handleSubmit,
    watch,
    control,
    setValue,
    formState: { errors, isDirty },
  } = useForm<OnboardingStep3Data>({
    resolver: zodResolver(step3Schema),
    defaultValues: {
      annualIncome: initialData?.annualIncome,
      savingsRate: initialData?.savingsRate,
      incomeSources: initialData?.incomeSources ?? [],
    },
  });

  const { fields, append, remove, update } = useFieldArray({
    control,
    name: 'incomeSources',
  });

  // Report changes to parent
  useEffect(() => {
    if (isDirty && onChange) {
      onChange();
    }
  }, [isDirty, onChange]);

  const annualIncome = watch('annualIncome') || 0;
  const savingsRate = watch('savingsRate') || 0;
  const incomeSources = watch('incomeSources') || [];
  const monthlySavings = (annualIncome * (savingsRate / 100)) / 12;

  // Calculate remaining income to allocate
  const allocatedIncome = incomeSources.reduce((sum, s) => sum + (s.annualAmount || 0), 0);
  const remainingIncome = annualIncome - allocatedIncome;

  // Toggle income type selection
  const toggleIncomeType = (type: IncomeSourceType) => {
    const newSelected = new Set(selectedTypes);
    const option = INCOME_SOURCE_OPTIONS.find(o => o.value === type);

    if (selectedTypes.has(type)) {
      // Remove this type
      newSelected.delete(type);
      const index = fields.findIndex(f => f.type === type);
      if (index !== -1) {
        remove(index);
      }
    } else {
      // Add this type
      newSelected.add(type);
      const isFirst = fields.length === 0;
      append({
        id: nanoid(),
        type,
        label: option?.label ?? type,
        annualAmount: isFirst ? annualIncome : 0,
        variability: 'recurring',
        flexibility: getDefaultFlexibility(type),
        isPrimary: isFirst,
        notes: '',
      });
    }
    setSelectedTypes(newSelected);
  };

  // Set primary income source
  const setPrimary = (index: number) => {
    fields.forEach((field, i) => {
      if (i === index) {
        update(i, { ...field, isPrimary: true });
      } else if (field.isPrimary) {
        update(i, { ...field, isPrimary: false });
      }
    });
  };

  return (
    <Card>
      <CardHeader>
        <CardTitle>Income & Savings</CardTitle>
        <CardDescription>
          Tell us about your income and how much you save
        </CardDescription>
      </CardHeader>
      <CardContent>
        <form onSubmit={handleSubmit(onNext)} className="space-y-8">
          {/* Part 1: Total Income & Savings Rate */}
          <div className="space-y-6">
            <div className="space-y-2">
              <Label htmlFor="annualIncome">
                What is your total annual income?
              </Label>
              <div className="relative">
                <span className="absolute left-3 top-2.5 text-muted-foreground">$</span>
                <Input
                  id="annualIncome"
                  type="number"
                  placeholder="75000"
                  className="pl-7"
                  {...register('annualIncome', { valueAsNumber: true })}
                />
              </div>
              {errors.annualIncome && (
                <p className="text-sm text-red-500">{errors.annualIncome.message}</p>
              )}
            </div>

            <div className="space-y-2">
              <Label htmlFor="savingsRate">
                What percentage of your income do you save for retirement?
              </Label>
              <div className="relative">
                <Input
                  id="savingsRate"
                  type="number"
                  placeholder="15"
                  {...register('savingsRate', { valueAsNumber: true })}
                />
                <span className="absolute right-3 top-2.5 text-muted-foreground">%</span>
              </div>
              {errors.savingsRate && (
                <p className="text-sm text-red-500">{errors.savingsRate.message}</p>
              )}
              {annualIncome > 0 && savingsRate > 0 && (
                <p className="text-sm text-blue-600 dark:text-blue-400">
                  You&apos;re saving approximately ${monthlySavings.toFixed(0)} per month
                </p>
              )}
            </div>
          </div>

          {/* Part 2: Income Source Classification */}
          {annualIncome > 0 && (
            <div className="space-y-4 pt-4 border-t">
              <div>
                <Label className="text-base font-semibold">
                  How do you earn this income?
                </Label>
                <p className="text-sm text-muted-foreground mt-1">
                  Select all that apply. This helps us understand your tax situation.
                </p>
              </div>

              {/* Income Type Selection Cards */}
              <div className="grid grid-cols-1 md:grid-cols-2 gap-3">
                {INCOME_SOURCE_OPTIONS.map((option) => (
                  <button
                    key={option.value}
                    type="button"
                    onClick={() => toggleIncomeType(option.value)}
                    className={cn(
                      'p-4 rounded-lg border-2 text-left transition-colors',
                      selectedTypes.has(option.value)
                        ? 'border-primary bg-primary/5'
                        : 'border-border hover:border-primary/50'
                    )}
                  >
                    <div className="font-medium">{option.label}</div>
                    <div className="text-sm text-muted-foreground mt-1">
                      {option.description}
                    </div>
                  </button>
                ))}
              </div>

              {/* Income Source Details */}
              {fields.length > 0 && (
                <div className="space-y-4 mt-6">
                  <div className="flex items-center justify-between">
                    <Label className="text-base font-semibold">
                      Income Breakdown
                    </Label>
                    {remainingIncome !== 0 && (
                      <span className={cn(
                        'text-sm font-medium',
                        remainingIncome > 0 ? 'text-amber-600' : 'text-red-600'
                      )}>
                        {remainingIncome > 0 ? `$${remainingIncome.toLocaleString()} remaining` : `$${Math.abs(remainingIncome).toLocaleString()} over`}
                      </span>
                    )}
                  </div>

                  {fields.map((field, index) => {
                    const option = INCOME_SOURCE_OPTIONS.find(o => o.value === field.type);
                    return (
                      <Collapsible key={field.id} defaultOpen={true}>
                        <div className="border rounded-lg">
                          <CollapsibleTrigger className="flex items-center justify-between w-full p-4 hover:bg-muted/50">
                            <div className="flex items-center gap-3">
                              {field.isPrimary && (
                                <Star className="h-4 w-4 text-amber-500 fill-amber-500" />
                              )}
                              <span className="font-medium">{option?.label}</span>
                            </div>
                            <div className="flex items-center gap-3">
                              <span className="text-sm text-muted-foreground">
                                ${(incomeSources[index]?.annualAmount || 0).toLocaleString()}
                              </span>
                              <ChevronDown className="h-4 w-4" />
                            </div>
                          </CollapsibleTrigger>
                          <CollapsibleContent>
                            <div className="p-4 pt-0 space-y-4">
                              {/* Amount */}
                              <div className="space-y-2">
                                <Label>Annual amount from this source</Label>
                                <div className="relative">
                                  <span className="absolute left-3 top-2.5 text-muted-foreground">$</span>
                                  <Input
                                    type="number"
                                    className="pl-7"
                                    {...register(`incomeSources.${index}.annualAmount`, { valueAsNumber: true })}
                                  />
                                </div>
                              </div>

                              {/* Variability */}
                              <div className="space-y-2">
                                <Label>How predictable is this income?</Label>
                                <Controller
                                  control={control}
                                  name={`incomeSources.${index}.variability`}
                                  render={({ field: radioField }) => (
                                    <RadioGroup
                                      value={radioField.value}
                                      onValueChange={radioField.onChange}
                                      className="flex flex-wrap gap-4"
                                    >
                                      {INCOME_VARIABILITY_OPTIONS.map((opt) => (
                                        <div key={opt.value} className="flex items-center space-x-2">
                                          <RadioGroupItem value={opt.value} id={`${field.id}-${opt.value}`} />
                                          <Label htmlFor={`${field.id}-${opt.value}`} className="font-normal cursor-pointer">
                                            {opt.label}
                                          </Label>
                                        </div>
                                      ))}
                                    </RadioGroup>
                                  )}
                                />
                              </div>

                              {/* Primary & Remove */}
                              <div className="flex items-center justify-between pt-2">
                                <div className="flex items-center space-x-2">
                                  <Checkbox
                                    id={`primary-${field.id}`}
                                    checked={field.isPrimary}
                                    onCheckedChange={() => setPrimary(index)}
                                  />
                                  <Label htmlFor={`primary-${field.id}`} className="font-normal cursor-pointer">
                                    This is my primary income source
                                  </Label>
                                </div>
                                <Button
                                  type="button"
                                  variant="ghost"
                                  size="sm"
                                  onClick={() => {
                                    const newSelected = new Set(selectedTypes);
                                    newSelected.delete(field.type);
                                    setSelectedTypes(newSelected);
                                    remove(index);
                                  }}
                                  className="text-destructive hover:text-destructive"
                                >
                                  <Trash2 className="h-4 w-4" />
                                </Button>
                              </div>

                              {/* Flexibility badges (read-only info) */}
                              <div className="flex flex-wrap gap-2 pt-2 border-t">
                                <span className="text-xs text-muted-foreground">Tax flexibility:</span>
                                {option?.defaultFlexibility.canDefer && (
                                  <span className="text-xs bg-green-100 text-green-800 dark:bg-green-900 dark:text-green-200 px-2 py-0.5 rounded">
                                    Deferrable
                                  </span>
                                )}
                                {option?.defaultFlexibility.canReduce && (
                                  <span className="text-xs bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-200 px-2 py-0.5 rounded">
                                    Deductible
                                  </span>
                                )}
                                {option?.defaultFlexibility.canRestructure && (
                                  <span className="text-xs bg-purple-100 text-purple-800 dark:bg-purple-900 dark:text-purple-200 px-2 py-0.5 rounded">
                                    Restructurable
                                  </span>
                                )}
                                {!option?.defaultFlexibility.canDefer &&
                                 !option?.defaultFlexibility.canReduce &&
                                 !option?.defaultFlexibility.canRestructure && (
                                  <span className="text-xs bg-gray-100 text-gray-600 dark:bg-gray-800 dark:text-gray-400 px-2 py-0.5 rounded">
                                    Fixed
                                  </span>
                                )}
                              </div>
                            </div>
                          </CollapsibleContent>
                        </div>
                      </Collapsible>
                    );
                  })}

                  {errors.incomeSources && (
                    <p className="text-sm text-red-500">{errors.incomeSources.message}</p>
                  )}
                </div>
              )}
            </div>
          )}

          <div className="flex gap-3 pt-4">
            <Button
              type="button"
              variant="outline"
              onClick={onBack}
              className="flex-1"
            >
              {cancelLabel}
            </Button>
            <Button type="submit" className="flex-1">
              {submitLabel}
            </Button>
          </div>
        </form>
      </CardContent>
    </Card>
  );
}
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [x] Linting passes: `npm run lint`
- [x] Dev server runs without errors: `npm run dev`

#### Manual Verification:
- [ ] Step 3 displays total income and savings rate fields
- [ ] Income source type cards appear when income > 0
- [ ] Clicking a card adds it to the breakdown list
- [ ] Each source shows amount, variability, and primary checkbox
- [ ] Tax flexibility badges display correctly
- [ ] "Remaining" indicator shows when amounts don't sum to total
- [ ] Validation error appears if sources don't sum to total income
- [ ] Validation error appears if no primary source is selected

**Implementation Note**: Test the UI thoroughly in the onboarding flow before proceeding.

---

## Phase 4: API & Data Persistence

### Overview
Update the onboarding API to save and retrieve income sources.

### Changes Required:

#### 1. Update Onboarding Complete API
**File**: `src/app/api/onboarding/complete/route.ts`

Add `incomeSources` to the data being saved:

```typescript
// In the insert/update to financial_snapshot, add:
incomeSources: data.incomeSources ?? null,
```

#### 2. Update Profile Data Loading
**File**: `src/app/profile/profile-client.tsx`

Add income sources to the profile data type and display.

In the profile data fetching, ensure `income_sources` is retrieved from the database.

Add a display section for income sources:

```typescript
{/* Income Sources Section */}
<Collapsible
  title="Income Sources"
  defaultOpen
  onEdit={() => setEditSection('income-sources')}
>
  {profileData.incomeSources && profileData.incomeSources.length > 0 ? (
    <div className="space-y-3">
      {profileData.incomeSources.map((source) => (
        <div key={source.id} className="flex justify-between text-sm border-b pb-2 last:border-0">
          <div>
            <span className="font-medium">{source.label}</span>
            {source.isPrimary && (
              <span className="ml-2 text-xs bg-amber-100 text-amber-800 px-1.5 py-0.5 rounded">
                Primary
              </span>
            )}
            <div className="text-xs text-muted-foreground mt-1">
              {source.variability === 'recurring' ? 'Recurring' :
               source.variability === 'variable' ? 'Variable' : 'Seasonal'} income
            </div>
          </div>
          <span className="font-medium">${source.annualAmount.toLocaleString()}/yr</span>
        </div>
      ))}
    </div>
  ) : (
    <p className="text-sm text-muted-foreground">No income sources specified</p>
  )}
</Collapsible>
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [ ] API responds correctly (manual test via curl or browser)

#### Manual Verification:
- [ ] Complete onboarding with income sources
- [ ] Income sources are saved to database (check via database client)
- [ ] Profile page displays income sources correctly
- [ ] Editing income sources from profile works

---

## Phase 5: Projection Engine Integration

### Overview
Update the projection engine to use aggregated income sources while maintaining backward compatibility.

### Changes Required:

#### 1. Update Input Builder
**File**: `src/lib/projections/input-builder.ts`

```typescript
// Update the income calculation to use income sources if available
const totalAnnualIncome = snapshot.incomeSources?.length > 0
  ? snapshot.incomeSources.reduce((sum, source) => {
      // Apply variability adjustment for conservative estimates
      const adjustmentFactor = source.variability === 'variable' ? 0.85
        : source.variability === 'seasonal' ? 0.90
        : 1.0;
      return sum + (source.annualAmount * adjustmentFactor);
    }, 0)
  : Number(snapshot.annualIncome);
```

#### 2. Update API Route
**File**: `src/app/api/projections/calculate/route.ts`

Update the Social Security estimation to use aggregated income:

```typescript
// In buildIncomeStreams function, update the income source for SS estimation
const incomeForSS = snapshot.incomeSources?.length > 0
  ? snapshot.incomeSources.reduce((sum, s) => sum + s.annualAmount, 0)
  : parseFloat(snapshot.annualIncome);

const ssMonthly = overrides?.socialSecurityMonthly ??
  estimateSocialSecurityMonthly(incomeForSS);
```

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [ ] Existing projection tests pass (if any)

#### Manual Verification:
- [ ] Run projections for a user with income sources - values look reasonable
- [ ] Run projections for a user without income sources (legacy) - still works
- [ ] Variable income sources result in slightly lower projected values (85% factor)

---

## Phase 6: Review Step & Polish

### Overview
Update the review step to show income sources and add any final polish.

### Changes Required:

#### 1. Update Review Step
**File**: `src/components/onboarding/step5-review.tsx`

Add income sources to the review display in the Financial Information section:

```typescript
{/* After Annual Income display */}
{data.incomeSources && data.incomeSources.length > 0 && (
  <div className="space-y-2">
    <Label className="text-muted-foreground">Income Sources</Label>
    <div className="space-y-1">
      {data.incomeSources.map((source) => (
        <div key={source.id} className="flex justify-between text-sm">
          <span>
            {source.label}
            {source.isPrimary && ' (Primary)'}
          </span>
          <span>${source.annualAmount.toLocaleString()}</span>
        </div>
      ))}
    </div>
  </div>
)}
```

#### 2. Export New Types
**File**: `src/types/index.ts` (if exists) or ensure exports in `src/types/onboarding.ts`

Make sure `IncomeSource`, `IncomeSourceType`, etc. are properly exported.

#### 3. Export Validation Schema
**File**: `src/lib/validation/index.ts` (if exists)

Export the new income sources validation schema.

### Success Criteria:

#### Automated Verification:
- [x] TypeScript compiles: `npm run typecheck`
- [x] Linting passes: `npm run lint`
- [x] Build succeeds: `npm run build`

#### Manual Verification:
- [ ] Review step shows income sources breakdown
- [ ] Complete end-to-end onboarding flow works
- [ ] All data persists correctly

---

## Testing Strategy

### Unit Tests

Create `src/lib/validation/__tests__/income-sources.test.ts`:

```typescript
import { describe, it, expect } from 'vitest';
import { incomeSourceSchema } from '../income-sources';
import { step3Schema } from '../onboarding';

describe('incomeSourceSchema', () => {
  it('validates a valid income source', () => {
    const validSource = {
      id: '1',
      type: 'w2_employment',
      label: 'W-2 Employment',
      annualAmount: 75000,
      variability: 'recurring',
      flexibility: { canDefer: false, canReduce: false, canRestructure: false },
      isPrimary: true,
    };
    expect(incomeSourceSchema.safeParse(validSource).success).toBe(true);
  });

  it('rejects invalid income type', () => {
    const invalidSource = {
      id: '1',
      type: 'invalid_type',
      label: 'Test',
      annualAmount: 75000,
      variability: 'recurring',
      flexibility: { canDefer: false, canReduce: false, canRestructure: false },
      isPrimary: true,
    };
    expect(incomeSourceSchema.safeParse(invalidSource).success).toBe(false);
  });
});

describe('step3Schema with income sources', () => {
  it('validates when income sources sum to annual income', () => {
    const data = {
      annualIncome: 100000,
      savingsRate: 15,
      incomeSources: [
        {
          id: '1',
          type: 'w2_employment',
          label: 'W-2 Employment',
          annualAmount: 80000,
          variability: 'recurring',
          flexibility: { canDefer: false, canReduce: false, canRestructure: false },
          isPrimary: true,
        },
        {
          id: '2',
          type: 'rental_income',
          label: 'Rental Income',
          annualAmount: 20000,
          variability: 'recurring',
          flexibility: { canDefer: false, canReduce: true, canRestructure: false },
          isPrimary: false,
        },
      ],
    };
    expect(step3Schema.safeParse(data).success).toBe(true);
  });

  it('rejects when income sources do not sum to annual income', () => {
    const data = {
      annualIncome: 100000,
      savingsRate: 15,
      incomeSources: [
        {
          id: '1',
          type: 'w2_employment',
          label: 'W-2 Employment',
          annualAmount: 50000, // Only 50k, not 100k
          variability: 'recurring',
          flexibility: { canDefer: false, canReduce: false, canRestructure: false },
          isPrimary: true,
        },
      ],
    };
    expect(step3Schema.safeParse(data).success).toBe(false);
  });

  it('rejects when no primary source is marked', () => {
    const data = {
      annualIncome: 100000,
      savingsRate: 15,
      incomeSources: [
        {
          id: '1',
          type: 'w2_employment',
          label: 'W-2 Employment',
          annualAmount: 100000,
          variability: 'recurring',
          flexibility: { canDefer: false, canReduce: false, canRestructure: false },
          isPrimary: false, // No primary!
        },
      ],
    };
    expect(step3Schema.safeParse(data).success).toBe(false);
  });
});
```

### Manual Testing Steps

1. **New User Flow**:
   - Start fresh onboarding
   - Enter annual income of $120,000
   - Select W-2 Employment ($100,000) and Rental Income ($20,000)
   - Mark W-2 as primary
   - Set variability for each
   - Complete onboarding
   - Verify data in profile page

2. **Existing User Migration**:
   - Log in as existing user without income sources
   - Verify projections still work
   - Edit profile to add income sources
   - Verify projections update correctly

3. **Edge Cases**:
   - Try to proceed without income sources summing to total
   - Try to proceed without selecting a primary source
   - Select only investment income (no primary income)
   - Select all 6 income types

---

## Migration Notes

### Existing Users
- Existing users without `income_sources` data continue to work via backward compatibility
- The `annualIncome` field is used as fallback when `income_sources` is empty/null
- No forced migration - users can optionally add income source details from profile

### Database
- New `income_sources` column is nullable, no data migration needed
- Existing `annualIncome` column remains as the "total" value

---

## References

- Original ticket: `thoughts/personal/tickets/epic-7/story-1-scope.md`
- Research document: `thoughts/shared/research/2026-01-15-story-7.1-income-source-classification.md`
- Existing Step 3: `src/components/onboarding/step3-financial-info.tsx`
- Onboarding types: `src/types/onboarding.ts:70-73`
- Validation schemas: `src/lib/validation/onboarding.ts:30-39`
- Financial snapshot schema: `src/db/schema/financial-snapshot.ts`
- Projection input builder: `src/lib/projections/input-builder.ts`
