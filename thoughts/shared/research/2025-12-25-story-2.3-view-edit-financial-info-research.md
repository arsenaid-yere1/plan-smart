---
date: 2025-12-25T12:00:00-08:00
researcher: Claude
git_commit: a1555b0095c4af4d1c1ccc4c362001faba48219a
branch: main
repository: plan-smart
topic: "Story 2.3 - View and Edit Financial Information Implementation Research"
tags: [research, codebase, story-2.3, epic-2, financial-profile, onboarding, editing]
status: complete
last_updated: 2025-12-25
last_updated_by: Claude
---

# Research: Story 2.3 - View and Edit Financial Information

**Date**: 2025-12-25T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: a1555b0095c4af4d1c1ccc4c362001faba48219a
**Branch**: main
**Repository**: plan-smart

## Research Question

What existing components, patterns, and infrastructure can be reused to implement Story 2.3 (View and Edit Financial Information), which allows users to view and edit their financial information after onboarding?

## Summary

The codebase has comprehensive infrastructure for implementing Story 2.3:

1. **No dedicated profile page exists** - Financial data is collected during onboarding and displayed on `/plans`, but there's no `/profile` or "Your Inputs" page
2. **Excellent component reuse opportunity** - The `Step5Review` component already implements the exact modal-based editing pattern needed
3. **Complete validation schemas exist** - All onboarding validation schemas can be reused via `profileUpdateSchema.partial()`
4. **Projection recompute is fast** - Engine completes in <100ms with no caching needed
5. **Database schema is ready** - All financial data stored in `financial_snapshot` with JSONB columns for complex data

## Detailed Findings

### 1. Current Application Structure

#### Existing Routes
| Route | Purpose | Has Edit Capability |
|-------|---------|---------------------|
| `/` | Landing page | No |
| `/onboarding` | Multi-step wizard | Yes (during onboarding) |
| `/plans` | Projection results display | No (view only) |
| `/dashboard` | Redirects to onboarding or plans | No |
| `/auth/*` | Authentication pages | No |

#### Navigation Component
[navigation.tsx](src/components/layout/navigation.tsx) shows only "Dashboard" and "Plans" links - no "Profile" or "Settings" link exists.

**Gap Identified**: Need to create `/profile` route and add navigation link.

**Decision**: Page will be located at `/profile`.

### 2. Existing Components for Reuse

#### Step5Review - Primary Pattern Template
[step5-review.tsx](src/components/onboarding/step5-review.tsx)

This component implements exactly what Story 2.3 needs:

**Display Pattern (lines 94-263)**:
- Collapsible sections for each data category
- Formatted display of all financial fields
- Currency and percentage formatting helpers

**Edit Modal Pattern (lines 288-377)**:
- `editSection` state tracks which section is being edited
- Dialog components wrap original step forms
- `handleEditSave` updates data and closes modal
- Each step component reused for editing

```typescript
// Pattern from step5-review.tsx:38-46
type EditSection =
  | 'basics'
  | 'retirement'
  | 'income'
  | 'risk'
  | 'savings'
  | 'expenses'
  | 'assets'
  | null;
```

#### Individual Step Components
All step components accept `initialData` prop and can be reused:

| Component | Data | Location |
|-----------|------|----------|
| `Step1PersonalInfo` | birthYear | [step1-personal-info.tsx](src/components/onboarding/step1-personal-info.tsx) |
| `Step2RetirementInfo` | targetRetirementAge, filingStatus | [step2-retirement-info.tsx](src/components/onboarding/step2-retirement-info.tsx) |
| `Step3FinancialInfo` | annualIncome, savingsRate | [step3-financial-info.tsx](src/components/onboarding/step3-financial-info.tsx) |
| `Step4RiskTolerance` | riskTolerance | [step4-risk-tolerance.tsx](src/components/onboarding/step4-risk-tolerance.tsx) |
| `Step2bSavingsContributions` | investmentAccounts[] | [step2b-savings-contributions.tsx](src/components/onboarding/step2b-savings-contributions.tsx) |
| `Step3bIncomeExpenses` | monthlyEssential, monthlyDiscretionary | [step3b-income-expenses.tsx](src/components/onboarding/step3b-income-expenses.tsx) |
| `Step4bAssetsDebts` | primaryResidence, debts[] | [step4b-assets-debts.tsx](src/components/onboarding/step4b-assets-debts.tsx) |

#### Collapsible Component
[collapsible.tsx](src/components/ui/collapsible.tsx) provides expand/collapse with optional edit button.

### 3. Database Schema

#### Financial Snapshot Table
[financial-snapshot.ts](src/db/schema/financial-snapshot.ts:40-63)

**Scalar Fields**:
- `birthYear` (integer)
- `targetRetirementAge` (integer)
- `maxAge` (integer, default 90)
- `filingStatus` (text)
- `annualIncome` (numeric 12,2)
- `savingsRate` (numeric 5,2)
- `riskTolerance` (text)

**JSONB Fields** (Epic 2 additions):
- `investmentAccounts` - Array of investment account objects
- `primaryResidence` - Home equity data
- `debts` - Array of debt objects
- `incomeExpenses` - Monthly expense breakdown

### 4. Validation Schemas

#### Existing Schemas
[onboarding.ts](src/lib/validation/onboarding.ts)

| Schema | Fields | Lines |
|--------|--------|-------|
| `step1Schema` | birthYear | 5-10 |
| `step2Schema` | targetRetirementAge, filingStatus | 12-18 |
| `step3Schema` | annualIncome, savingsRate | 20-29 |
| `step4Schema` | riskTolerance | 31-33 |
| `step2SavingsSchema` | investmentAccounts[] | 49-52 |
| `step3IncomeExpensesSchema` | incomeExpenses | 55-61 |
| `step4AssetsDebtsSchema` | primaryResidence, debts[] | 75-84 |
| `completeOnboardingSchemaV2` | All fields merged | 87-93 |

#### Profile Update Schema (Already Exists!)
[profile.ts](src/lib/validation/profile.ts:13-20)

```typescript
export const profileUpdateSchema = step1Schema
  .merge(step2Schema)
  .merge(step3Schema)
  .merge(step4Schema)
  .merge(step2SavingsSchema)
  .merge(step3IncomeExpensesSchema)
  .merge(step4AssetsDebtsSchema)
  .partial(); // All fields optional for updates
```

### 5. Projection Recompute Logic

#### Calculation Engine
[engine.ts](src/lib/projections/engine.ts)

- `runProjection()` function (lines 98-223)
- Pure TypeScript computation, no external dependencies
- Performance: <100ms execution (verified by tests)
- No caching currently implemented (not needed given speed)

#### API Endpoint
[route.ts](src/app/api/projections/calculate/route.ts)

- GET: Calculate with defaults
- POST: Calculate with overrides
- Returns projection + inputs + meta (timing)

#### Server Component Path
[page.tsx](src/app/plans/page.tsx:199-207)

Plans page calls `runProjection()` directly during SSR.

**Recompute Strategy for Story 2.3**:
1. Save updated financial data to database
2. Call projection API or recompute inline
3. Redirect to `/plans` or update displayed results

### 6. Edit/Save Patterns

#### Current Patterns (What Exists)
| Pattern | Implementation | Location |
|---------|----------------|----------|
| React Hook Form | All forms | Throughout |
| Zod validation | `zodResolver()` | All step components |
| Loading states | `isLoading` state + disabled inputs | All forms |
| Error states | `error` state + Alert component | All forms |
| Dialog modals | For section editing | Step5Review |
| Dynamic arrays | `useFieldArray` | Accounts, Debts |

#### Missing Patterns (Gaps for Story 2.3)
| Pattern | Needed For | Current Status |
|---------|------------|----------------|
| Dirty state tracking | Unsaved changes warning | `isDirty` available but unused |
| Confirmation dialogs | Discard changes | Not implemented |
| PATCH/PUT endpoints | Partial updates | Only POST exists |
| Toast notifications | Save feedback | System exists but unused |
| Profile update API | Saving edits | Needs to be created |

### 7. Data Flow for Profile Updates

#### Current Onboarding Flow
```
[Onboarding Wizard]
  → POST /api/onboarding/complete
  → INSERT financial_snapshot
  → INSERT plans
  → UPDATE user_profile.onboardingCompleted = true
  → Redirect to /plans
```

#### Proposed Profile Update Flow
```
[Profile Page]
  → User edits field(s) in modal
  → Client validates with profileUpdateSchema
  → PATCH /api/profile (new endpoint needed)
  → UPDATE financial_snapshot
  → Recompute projection (inline or via API)
  → Update UI with new results
  → Show success toast
```

## Code References

### Components to Reuse
- [src/components/onboarding/step5-review.tsx](src/components/onboarding/step5-review.tsx) - Primary pattern template
- [src/components/onboarding/step1-personal-info.tsx](src/components/onboarding/step1-personal-info.tsx) - Age editing
- [src/components/onboarding/step2-retirement-info.tsx](src/components/onboarding/step2-retirement-info.tsx) - Retirement goals
- [src/components/onboarding/step3-financial-info.tsx](src/components/onboarding/step3-financial-info.tsx) - Income/savings
- [src/components/onboarding/step4-risk-tolerance.tsx](src/components/onboarding/step4-risk-tolerance.tsx) - Risk tolerance
- [src/components/onboarding/step2b-savings-contributions.tsx](src/components/onboarding/step2b-savings-contributions.tsx) - Investment accounts
- [src/components/onboarding/step3b-income-expenses.tsx](src/components/onboarding/step3b-income-expenses.tsx) - Expenses
- [src/components/onboarding/step4b-assets-debts.tsx](src/components/onboarding/step4b-assets-debts.tsx) - Assets/debts
- [src/components/ui/collapsible.tsx](src/components/ui/collapsible.tsx) - Collapsible sections

### Validation to Reuse
- [src/lib/validation/onboarding.ts](src/lib/validation/onboarding.ts) - All step schemas
- [src/lib/validation/profile.ts](src/lib/validation/profile.ts) - Profile update schema (partial)

### Database Schema
- [src/db/schema/financial-snapshot.ts](src/db/schema/financial-snapshot.ts) - Financial data table

### Projection Logic
- [src/lib/projections/engine.ts](src/lib/projections/engine.ts) - Calculation engine
- [src/app/api/projections/calculate/route.ts](src/app/api/projections/calculate/route.ts) - API endpoint

## Architecture Insights

### Component Architecture
- **Pattern**: Modal-based editing following Step5Review
- **State Management**: React Hook Form for forms, useState for modals
- **Validation**: Zod schemas with zodResolver integration
- **Data Flow**: Form → Validation → API → Database → Recompute → UI Update

### Recommended Implementation Approach

1. **Create Profile Page** (`/app/profile/page.tsx`)
   - Server component fetching financial snapshot
   - Client component for interactive editing
   - Reuse Step5Review collapsible/modal pattern

2. **Create Profile API** (`/app/api/profile/route.ts`)
   - PATCH handler for partial updates
   - Use profileUpdateSchema for validation
   - Return updated snapshot + projection

3. **Add Navigation Link**
   - Update navigation.tsx to include "Profile" link

4. **Implement UX Safeguards**
   - Track dirty state using formState.isDirty
   - Add confirmation dialog before closing with unsaved changes
   - Use toast for save success/failure feedback

5. **Trigger Recompute**
   - After save, recompute projection inline
   - Update Plans page data or redirect

## Historical Context (from thoughts/)

### Related Research Documents
- [2025-12-25-story-2.3-onboarding-components-research.md](thoughts/shared/research/2025-12-25-story-2.3-onboarding-components-research.md) - Earlier component analysis
- [2025-12-05-epic-2-onboarding-wizard-implementation.md](thoughts/shared/research/2025-12-05-epic-2-onboarding-wizard-implementation.md) - Epic 2 implementation research
- [2025-12-16-epic-2-onboarding-wizard-validation.md](thoughts/shared/research/2025-12-16-epic-2-onboarding-wizard-validation.md) - Validation matrix

### Related Tickets
- [story-1-scope.md](thoughts/personal/tickets/epic-2/onboarding/story-1-scope.md) - Initial wizard design
- [story-2-scope.md](thoughts/personal/tickets/epic-2/onboarding/story-2-scope.md) - Display financial results
- [story-3-scope.md](thoughts/personal/tickets/epic-2/onboarding/story-3-scope.md) - **Current story** - View and edit financial info

## Implementation Checklist

Based on Story 2.3 Acceptance Criteria:

### Display
- [ ] Create `/profile` page
- [ ] Display all financial data in collapsible sections
- [ ] Show age, retirement age, lifespan
- [ ] Show current assets (grouped by type)
- [ ] Show monthly contributions
- [ ] Show income streams
- [ ] Show retirement spending target
- [ ] Values match data used in latest projection

### Editing
- [ ] Each section has "Edit" button
- [ ] Edit opens modal with step form component
- [ ] Fields validated with same rules as onboarding
- [ ] Support inline edit OR modal (choose modal per existing pattern)

### Save & Recompute
- [ ] Create PATCH /api/profile endpoint
- [ ] Save persists to database
- [ ] Projection automatically re-runs on save
- [ ] Results screen updates
- [ ] Recompute completes in ≤2 seconds ✓ (engine is <100ms)

### UX Safeguards
- [ ] Track unsaved changes (use isDirty)
- [ ] Indicate unsaved changes clearly
- [ ] Allow cancel without affecting current plan
- [ ] Clear distinction: editing reality vs exploring scenarios

## Decisions Made

1. **Page Location**: `/profile` (confirmed)
2. **Navigation Placement**: Header nav - add "Profile" alongside existing "Dashboard" and "Plans" links
3. **After Save Behavior**: Stay on `/profile` and show success toast notification. Projection recomputes when user navigates to `/plans` (uses updated profile data)

## Open Questions

1. **Scenario Distinction**: How to visually distinguish "editing reality" from "what-if analysis" (future feature)?
