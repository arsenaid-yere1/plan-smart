---
date: 2025-12-25T12:00:00-08:00
researcher: Claude
git_commit: ab36ff2b7362fc8c1e376a1bc6857f063587f068
branch: main
repository: plan-smart
topic: "Story 2.4 — Adjust Assumptions Implementation Research"
tags: [research, codebase, projection-engine, assumptions, epic-3, story-2.4]
status: complete
last_updated: 2025-12-25
last_updated_by: Claude
---

# Research: Story 2.4 — Adjust Assumptions Implementation

**Date**: 2025-12-25T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: ab36ff2b7362fc8c1e376a1bc6857f063587f068
**Branch**: main
**Repository**: plan-smart

## Research Question

How should Story 2.4 "Adjust Assumptions" be implemented given the current codebase architecture? What exists, what needs to be built, and what patterns should be followed?

## Summary

The codebase has a **fully operational projection engine** with a clean separation between financial profile data (persistent) and projection assumptions (ephemeral). The API already supports assumption overrides via POST parameters. The main gap is the **UI layer** — there's no assumptions panel, no slider components, and no real-time recalculation interface. Implementation requires building a client-side assumptions panel with controls that call the existing API.

### Key Findings

| Aspect | Current State | Gap |
|--------|---------------|-----|
| Projection Engine | ✅ Complete | None |
| API Override Support | ✅ Complete | None |
| Validation Schemas | ✅ Complete | None |
| Default Assumptions | ✅ Defined | None |
| Assumptions UI | ❌ Missing | New component needed |
| Slider Components | ❌ Missing | Need to add or build |
| Real-time Recalculation | ❌ Missing | Client-side fetch logic |
| Temporary State Management | ❌ Missing | Need ephemeral state pattern |

## Detailed Findings

### 1. Projection Engine (Complete)

The projection engine at [engine.ts](src/lib/projections/engine.ts) implements a year-by-year retirement simulation with:

**Core Algorithm:**
- **Accumulation Phase**: `(balance + contribution - debt) × (1 + return)`
- **Drawdown Phase**: `(balance - withdrawal) × (1 + return)`

**Key Features:**
- Tax-aware withdrawal strategy (taxable → tax-deferred → tax-free)
- Dual inflation tracking (general 2.5%, healthcare 5%)
- Social Security income offset
- Healthcare cost age brackets
- Performance target: <100ms (actual: <500ms)

**Entry Point:** [route.ts:29-146](src/app/api/projections/calculate/route.ts#L29-L146)

### 2. Existing Assumptions Infrastructure

#### Default Values ([assumptions.ts](src/lib/projections/assumptions.ts))

```typescript
// Return rates by risk tolerance
DEFAULT_RETURN_RATES = {
  conservative: 0.04,  // 4%
  moderate: 0.06,      // 6%
  aggressive: 0.08,    // 8%
}

// Other defaults
DEFAULT_INFLATION_RATE = 0.025           // 2.5%
DEFAULT_MAX_AGE = 90
DEFAULT_SS_AGE = 67
DEFAULT_CONTRIBUTION_GROWTH_RATE = 0
DEFAULT_HEALTHCARE_INFLATION_RATE = 0.05 // 5%
```

#### Validation Ranges ([projections.ts](src/lib/validation/projections.ts))

| Parameter | Min | Max | Story Requirement |
|-----------|-----|-----|-------------------|
| `expectedReturn` | 0% | 20% | 1% – 10% |
| `inflationRate` | 0% | 15% | 1% – 8% |
| `maxAge` | 50 | 120 | N/A |
| `contributionGrowthRate` | 0% | 10% | N/A |
| `socialSecurityAge` | 62 | 70 | N/A |
| `socialSecurityMonthly` | $0 | $10,000 | N/A |

### 3. API Support for Overrides (Complete)

**POST `/api/projections/calculate`** already accepts optional overrides:

```typescript
interface ProjectionRequest {
  expectedReturn?: number;
  inflationRate?: number;
  maxAge?: number;
  contributionGrowthRate?: number;
  socialSecurityAge?: number;
  socialSecurityMonthly?: number;
  annualHealthcareCosts?: number;
  healthcareInflationRate?: number;
  contributionAllocation?: BalanceByType;
}
```

**Implementation:** [route.ts:177-209](src/app/api/projections/calculate/route.ts#L177-L209)

### 4. State Management Architecture

**Current Pattern:** Server-first hydration with optimistic local updates

```
Server Component → db.query.financialSnapshot
→ Transform to client-safe format
→ Pass as initialData to Client Component
→ Local useState for UI state
→ API calls for persistence
```

**Key Files:**
- [profile-client.tsx](src/app/profile/profile-client.tsx) — Profile editing pattern
- [plans/page.tsx](src/app/plans/page.tsx) — Server-side projection calculation
- [ProjectionChart.tsx](src/components/projections/ProjectionChart.tsx) — Client toggle state

**Gap:** No pattern for ephemeral assumptions state that:
- Lives only during page session
- Triggers API recalculation on change
- Resets on page navigation

### 5. UI Components Available

**Existing Components:**
- `Input` — Base number input ([input.tsx](src/components/ui/input.tsx))
- `Dialog` — Modal/drawer pattern ([dialog.tsx](src/components/ui/dialog.tsx))
- `Collapsible` — Expandable panel ([collapsible.tsx](src/components/ui/collapsible.tsx))
- `Card` — Layout container ([card.tsx](src/components/ui/card.tsx))
- `Button` — Action buttons ([button.tsx](src/components/ui/button.tsx))

**Missing Components:**
- ❌ Slider/Range input — Not in codebase
- ❌ Assumptions panel — New component needed

**Form Pattern:** react-hook-form with Zod validation (used in onboarding)

### 6. Clean Separation Model (From Story Scope)

```
Financial Profile  →  Assumptions  →  Projection  →  Results
      (facts)          (knobs)        (math)        (UI + AI)
```

**Implementation Locations:**
- **Financial Profile (facts):** `financial_snapshot` table, persisted
- **Assumptions (knobs):** API request parameters, ephemeral
- **Projection (math):** `runProjection()` in [engine.ts](src/lib/projections/engine.ts)
- **Results (UI):** [ProjectionChart.tsx](src/components/projections/ProjectionChart.tsx), [plans/page.tsx](src/app/plans/page.tsx)

## Architecture Insights

### Recommended Implementation Pattern

```
┌─────────────────────────────────────────────────────────────┐
│                     Plans Page (Server)                      │
│  - Fetch financialSnapshot                                   │
│  - Calculate initial projection with defaults                │
│  - Pass initialData to client                                │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                   PlansClient (Client)                       │
│  - useState for assumptions (ephemeral)                      │
│  - useState for projectionResult                             │
│  - Initialized with server defaults                          │
└──────────────────────────┬──────────────────────────────────┘
                           │
           ┌───────────────┴───────────────┐
           ▼                               ▼
┌─────────────────────┐         ┌─────────────────────────────┐
│  AssumptionsPanel   │         │     ProjectionChart         │
│  - Sliders/inputs   │         │     - Displays results      │
│  - Reset button     │         │     - Updates on data change│
│  - onChange → parent│         └─────────────────────────────┘
└──────────┬──────────┘
           │
           ▼
┌─────────────────────────────────────────────────────────────┐
│                    API Call Pattern                          │
│  POST /api/projections/calculate                             │
│  Body: { expectedReturn, inflationRate, ... }                │
│  Response: { projection, inputs, meta }                      │
└─────────────────────────────────────────────────────────────┘
```

### State Management Recommendation

**Option A: useState with debounced API calls (Recommended)**
```typescript
const [assumptions, setAssumptions] = useState(defaultAssumptions);
const [projection, setProjection] = useState(initialProjection);

// Debounced recalculation
useEffect(() => {
  const timer = setTimeout(async () => {
    const result = await fetch('/api/projections/calculate', {
      method: 'POST',
      body: JSON.stringify(assumptions),
    });
    setProjection(await result.json());
  }, 300); // 300ms debounce

  return () => clearTimeout(timer);
}, [assumptions]);
```

**Benefits:**
- Simple, no external libraries
- Matches existing patterns
- Ephemeral by default (resets on navigation)

### UI Component Recommendations

**For Sliders:** Either:
1. Add `@radix-ui/react-slider` (consistent with existing Radix usage)
2. Use HTML `<input type="range">` with custom styling

**Panel Pattern:** Use existing `Collapsible` or `Dialog` component

**Example Structure:**
```tsx
<Card>
  <CardHeader>
    <CardTitle>Assumptions</CardTitle>
    <Button variant="outline" onClick={resetToDefaults}>
      Reset to Default
    </Button>
  </CardHeader>
  <CardContent>
    <AssumptionSlider
      label="Expected Return"
      value={assumptions.expectedReturn}
      min={0.01}
      max={0.10}
      step={0.005}
      formatValue={(v) => `${(v * 100).toFixed(1)}%`}
      onChange={(v) => setAssumptions(prev => ({ ...prev, expectedReturn: v }))}
    />
    {/* More sliders... */}
  </CardContent>
</Card>
```

## Code References

### Projection Engine
- [engine.ts:98-223](src/lib/projections/engine.ts#L98-L223) — Main `runProjection()` function
- [engine.ts:13-42](src/lib/projections/engine.ts#L13-L42) — Tax-aware withdrawal strategy

### Assumptions & Defaults
- [assumptions.ts:7-11](src/lib/projections/assumptions.ts#L7-L11) — `DEFAULT_RETURN_RATES`
- [assumptions.ts:16](src/lib/projections/assumptions.ts#L16) — `DEFAULT_INFLATION_RATE`
- [assumptions.ts:21](src/lib/projections/assumptions.ts#L21) — `DEFAULT_MAX_AGE`

### Types & Validation
- [types.ts:33-67](src/lib/projections/types.ts#L33-L67) — `ProjectionInput` interface
- [types.ts:72-99](src/lib/projections/types.ts#L72-L99) — `ProjectionRequest` interface
- [validation/projections.ts:20-81](src/lib/validation/projections.ts#L20-L81) — Validation schemas

### API Routes
- [route.ts:29-146](src/app/api/projections/calculate/route.ts#L29-L146) — `calculateProjection()` helper
- [route.ts:177-209](src/app/api/projections/calculate/route.ts#L177-L209) — POST endpoint with overrides

### UI Patterns
- [ProjectionChart.tsx:45-124](src/components/projections/ProjectionChart.tsx#L45-L124) — Chart with toggle state
- [profile-client.tsx:51-85](src/app/profile/profile-client.tsx#L51-L85) — Local state with API persistence
- [dialog.tsx](src/components/ui/dialog.tsx) — Modal pattern
- [collapsible.tsx](src/components/ui/collapsible.tsx) — Expandable panel pattern

### Database Schema
- [financial-snapshot.ts:40-62](src/db/schema/financial-snapshot.ts#L40-L62) — User financial data (facts)

## Historical Context (from thoughts/)

### Story Scope Document
- [story-3-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-3-scope.md) — Full story requirements including:
  - Definition of assumptions vs facts
  - Acceptance criteria
  - Emotional design principles ("empowering, not risky")
  - Engineering model diagram

### Related Implementation Plans
- [2025-12-18-epic-3-story-1-projection-engine.md](thoughts/shared/plans/2025-12-18-epic-3-story-1-projection-engine.md) — Projection engine plan (completed)
- [2025-12-22-epic-3-story-2-visualization.md](thoughts/shared/plans/2025-12-22-epic-3-story-2-visualization.md) — Chart visualization plan

### Research Documents
- [2025-12-17-epic-3-projection-engine-implementation-readiness.md](thoughts/shared/research/2025-12-17-epic-3-projection-engine-implementation-readiness.md) — Data availability analysis

## Implementation Checklist

Based on research, Story 2.4 implementation requires:

### Phase 1: UI Infrastructure
- [ ] Add slider component (Radix or custom)
- [ ] Create `AssumptionsPanel` component
- [ ] Style controls with existing design system

### Phase 2: State Management
- [ ] Convert plans page to client component pattern
- [ ] Add ephemeral assumptions state
- [ ] Implement debounced API recalculation
- [ ] Add "Reset to Default" functionality

### Phase 3: Integration
- [ ] Connect panel to ProjectionChart
- [ ] Add loading states during recalculation
- [ ] Ensure ≤2 second update latency (per acceptance criteria)

### Phase 4: Polish
- [ ] Add visual distinction for default vs modified values
- [ ] Implement guardrails (min/max per story spec)
- [ ] Add empowering UX copy ("Try a more conservative return")

## Decisions Made

1. **Retirement age adjustment**: Ephemeral — does not persist to profile. The assumptions panel will show the user's `targetRetirementAge` from their profile as the initial value, but changes only affect the current projection session. Resets on page navigation.

2. **AI integration**: No AI narrative component exists currently. The story scope mentions "Provide deltas for AI explanation" as a system capability, but this is a future feature. For now, Story 2.4 should focus on the assumptions UI and recalculation — the projection delta data will be available for AI integration later.

3. **Mobile UX**: Bottom sheet (partial height) — the chart remains visible at the top while the assumptions panel slides up from the bottom. This enables real-time feedback as the user adjusts sliders, satisfying the "changes apply immediately" requirement.

## Open Questions

None — all key decisions have been made.

## Related Research

- [2025-12-25-story-2-display-financial-results-research.md](thoughts/shared/research/2025-12-25-story-2-display-financial-results-research.md)
- [2025-12-21-epic-3-story-2-visualization-research.md](thoughts/shared/research/2025-12-21-epic-3-story-2-visualization-research.md)