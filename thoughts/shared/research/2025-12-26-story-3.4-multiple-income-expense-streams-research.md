---
date: 2025-12-26T12:00:00-08:00
researcher: Claude
git_commit: 6e164b0c62148dc370f63f78546bf1ba75e61663
branch: main
repository: plan-smart
topic: "Story 3.4 - Support Multiple Income & Expense Streams Implementation"
tags: [research, codebase, projection-engine, income-streams, expense-streams, epic-3]
status: complete
last_updated: 2025-12-26
last_updated_by: Claude
last_updated_note: "Clarified income streams belong in financial profile, not projection config"
---

# Research: Story 3.4 — Support Multiple Income & Expense Streams

**Date**: 2025-12-26T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: 6e164b0c62148dc370f63f78546bf1ba75e61663
**Branch**: main
**Repository**: plan-smart

## Research Question

How should Story 3.4 (Support Multiple Income & Expense Streams) be implemented given the current projection system architecture, data models, and existing patterns?

## Summary

The current projection system uses a simplified income model where:
1. **Accumulation Phase**: Income flows into investments via monthly contributions (no direct income tracking)
2. **Drawdown Phase**: Only Social Security is modeled as retirement income; all other needs come from portfolio withdrawals

To implement Story 3.4, the system needs to be extended to support:
- Multiple discrete income streams with configurable start/end ages
- A primary retirement spending target that inflates annually
- Proper combination of asset growth, income inflows, and expense outflows

---

## Detailed Findings

### 1. Current Projection Engine Architecture

**Primary File**: [engine.ts](src/lib/projections/engine.ts)

The projection engine implements a year-by-year simulation with two distinct phases:

#### Accumulation Phase (lines 121-144)
```typescript
// Current logic during working years:
// 1. Grow contributions by contributionGrowthRate
// 2. Subtract debt payments from effective contribution
// 3. Allocate contributions across tax categories
// 4. Apply investment returns
```

**Key limitation**: No income tracking during accumulation — only contribution amounts matter.

#### Drawdown Phase (lines 145-195)
```typescript
// Current logic during retirement:
// 1. Calculate inflation-adjusted general expenses
// 2. Calculate healthcare expenses (separate inflation rate)
// 3. Add Social Security income if age >= socialSecurityAge
// 4. Calculate: withdrawalNeeded = max(0, expenses - ssIncome)
// 5. Execute tax-aware withdrawals
// 6. Apply returns to remaining balance
```

**Key limitation**: Only one income source (Social Security) is currently supported.

#### Withdrawal Strategy (lines 13-42)
Tax-optimized withdrawal order:
1. Taxable accounts (capital gains treatment)
2. Tax-deferred accounts (ordinary income)
3. Tax-free accounts (preserve Roth growth)

### 2. Current Income Handling

**Location**: [types.ts](src/lib/projections/types.ts) lines 61-63

```typescript
// Current income fields in ProjectionInput:
socialSecurityAge: number;
socialSecurityMonthly: number;
```

**Social Security Implementation** ([engine.ts:159-162](src/lib/projections/engine.ts#L159-L162)):
```typescript
let ssIncome = 0;
if (age >= input.socialSecurityAge && input.socialSecurityMonthly > 0) {
  ssIncome = (input.socialSecurityMonthly * 12) * inflationMultiplier;
}
```

**Key patterns to preserve**:
- Income starts at a specific age (configurable)
- Income is inflation-adjusted from retirement start
- Income reduces withdrawal needs from portfolio

### 3. Current Expense Handling

**Location**: [types.ts](src/lib/projections/types.ts) lines 54-59

```typescript
// Current expense fields in ProjectionInput:
annualExpenses: number;
annualHealthcareCosts: number;
healthcareInflationRate: number;
```

**Expense Calculation** ([engine.ts:146-156](src/lib/projections/engine.ts#L146-L156)):
```typescript
const inflationMultiplier = Math.pow(1 + input.inflationRate, yearsFromRetirement);
const generalExpenses = input.annualExpenses * inflationMultiplier;

const healthcareInflationMultiplier = Math.pow(1 + input.healthcareInflationRate, yearsFromRetirement);
const healthcareExpenses = input.annualHealthcareCosts * healthcareInflationMultiplier;

const expensesNeeded = generalExpenses + healthcareExpenses;
```

**Key patterns to preserve**:
- Expenses inflate from retirement year
- Different inflation rates for different expense types
- Total expenses drive withdrawal calculations

### 4. Data Models

#### Current ProjectionInput ([types.ts:33-67](src/lib/projections/types.ts#L33-L67))
```typescript
export interface ProjectionInput {
  currentAge: number;
  retirementAge: number;
  maxAge: number;
  balancesByType: BalanceByType;
  annualContribution: number;
  contributionAllocation: BalanceByType;
  expectedReturn: number;
  inflationRate: number;
  contributionGrowthRate: number;
  annualExpenses: number;
  annualHealthcareCosts: number;
  healthcareInflationRate: number;
  socialSecurityAge: number;
  socialSecurityMonthly: number;
  annualDebtPayments: number;
}
```

#### Database Schema ([financial-snapshot.ts](src/db/schema/financial-snapshot.ts))
Current `financial_snapshot` table stores:
- `annualIncome`: Single income field (line 50)
- `incomeExpenses`: JSONB with `monthlyEssential` and `monthlyDiscretionary` (line 58)

**Gap**: No support for multiple income streams with different start ages.

### 5. Inflation System

**Location**: [assumptions.ts](src/lib/projections/assumptions.ts)

| Rate Type | Default Value | Lines |
|-----------|--------------|-------|
| General inflation | 2.5% | 14-16 |
| Healthcare inflation | 5.0% | 43-45 |

**Compounding formula** ([engine.ts:148](src/lib/projections/engine.ts#L148)):
```typescript
Math.pow(1 + inflationRate, yearsFromRetirement)
```

---

## Proposed Data Model Extensions

### New Income Stream Type

```typescript
export interface IncomeStream {
  id: string;
  name: string;                    // e.g., "Social Security", "Rental Property", "Pension"
  type: IncomeStreamType;          // 'social_security' | 'pension' | 'rental' | 'annuity' | 'part_time' | 'other'
  annualAmount: number;            // In today's dollars
  startAge: number;                // Age when income begins
  endAge?: number;                 // Age when income ends (optional, null = lifetime)
  inflationAdjusted: boolean;      // Whether to apply inflation (COLA)
  taxability: 'taxable' | 'partially_taxable' | 'tax_free';
}

export type IncomeStreamType =
  | 'social_security'
  | 'pension'
  | 'rental'
  | 'annuity'
  | 'part_time'
  | 'other';
```

### Extended Expense Type

```typescript
export interface ExpenseCategory {
  id: string;
  name: string;                    // e.g., "Core Living", "Healthcare", "Travel"
  annualAmount: number;            // In today's dollars
  inflationRate: number;           // Category-specific inflation (default 2.5%)
  startAge?: number;               // When expense begins (default: retirement)
  endAge?: number;                 // When expense ends (optional)
}
```

### Updated ProjectionInput

```typescript
export interface ProjectionInput {
  // ... existing fields ...

  // Replace single Social Security fields with income streams
  incomeStreams: IncomeStream[];

  // Replace single expense fields with categories
  expenseCategories: ExpenseCategory[];

  // Keep annualExpenses as primary retirement spending target (renamed)
  primaryRetirementSpending: number;  // Base spending target in today's $
}
```

---

## Implementation Approach

### Phase 1: Database & Type System

1. Add `IncomeStreamJson` type to [financial-snapshot.ts](src/db/schema/financial-snapshot.ts)
2. Add `incomeStreams` JSONB column to `financial_snapshot` table
3. Add `IncomeStream` interface to [types.ts](src/lib/projections/types.ts)
4. Add `incomeStreams` array to `ProjectionInput` interface
5. Create database migration

```typescript
// In financial-snapshot.ts
export type IncomeStreamJson = {
  id: string;
  name: string;
  type: 'social_security' | 'pension' | 'rental' | 'annuity' | 'part_time' | 'other';
  annualAmount: number;
  startAge: number;
  endAge?: number;
  inflationAdjusted: boolean;
};

// New column
incomeStreams: jsonb('income_streams').$type<IncomeStreamJson[]>(),
```

### Phase 2: Onboarding Updates

1. Add new onboarding step for income streams collection (or extend existing step)
2. Create `IncomeStreamsForm` component with:
   - Add/remove income stream functionality
   - Type selection (Social Security, Pension, Rental, etc.)
   - Amount, start age, end age inputs
   - Inflation adjustment toggle
3. Add validation schema for income streams

### Phase 3: Engine Updates

**Modified calculation in drawdown phase** ([engine.ts:145-195](src/lib/projections/engine.ts#L145-L195)):

```typescript
// Calculate total income for this age
let totalIncome = 0;
for (const stream of input.incomeStreams) {
  if (age >= stream.startAge && (stream.endAge === undefined || age <= stream.endAge)) {
    const streamInflation = stream.inflationAdjusted
      ? Math.pow(1 + input.inflationRate, yearsFromRetirement)
      : 1;
    totalIncome += stream.annualAmount * streamInflation;
  }
}

// Calculate total expenses
const expensesNeeded = generalExpenses + healthcareExpenses;

// Calculate net withdrawal need
const withdrawalNeeded = Math.max(0, expensesNeeded - totalIncome);
```

### Phase 4: API Updates

Update [route.ts](src/app/api/projections/calculate/route.ts) to:
1. Read income streams from `financial_snapshot.incomeStreams`
2. Build `ProjectionInput.incomeStreams` from snapshot data
3. Include income breakdown in projection response
4. Handle backward compatibility (existing users with only SS data)

### Phase 5: Data Migration

1. Create migration script to convert existing `socialSecurityAge`/`socialSecurityMonthly` to income stream entry
2. Auto-generate Social Security income stream for existing users
3. Preserve existing data integrity

### Phase 6: UI Components

1. Create `IncomeStreamsEditor` for financial profile editing
2. Add income stream visualization to projection chart (stacked area or separate lines)
3. Show income breakdown in projection details/tooltips
4. Update financial profile summary to display income streams

---

## Code References

| Component | File | Lines | Description |
|-----------|------|-------|-------------|
| Projection Engine | [engine.ts](src/lib/projections/engine.ts) | 98-223 | Main `runProjection()` function |
| Type Definitions | [types.ts](src/lib/projections/types.ts) | 33-67 | `ProjectionInput` interface |
| SS Calculation | [engine.ts](src/lib/projections/engine.ts) | 159-162 | Current Social Security income logic |
| Expense Inflation | [engine.ts](src/lib/projections/engine.ts) | 146-156 | Expense inflation calculation |
| SS Estimation | [assumptions.ts](src/lib/projections/assumptions.ts) | 84-104 | `estimateSocialSecurityMonthly()` |
| API Route | [route.ts](src/app/api/projections/calculate/route.ts) | 29-149 | `calculateProjection()` function |
| DB Schema | [financial-snapshot.ts](src/db/schema/financial-snapshot.ts) | 40-62 | Financial data storage |
| Validation | [projections.ts](src/lib/validation/projections.ts) | 20-89 | Request validation schema |

---

## Architecture Insights

### Pattern: Income as Portfolio Supplement

The current architecture treats income (Social Security) as reducing portfolio withdrawal needs rather than adding to portfolio balance. This pattern should be preserved:

```
Net Withdrawal = max(0, Total Expenses - Total Income)
```

This approach:
- Avoids unnecessary tax events from withdrawals
- Preserves portfolio growth as long as possible
- Naturally handles income that exceeds expenses

### Pattern: Age-Based Activation

Income streams should follow the Social Security pattern of age-based activation:
```typescript
if (age >= stream.startAge && (stream.endAge === undefined || age <= stream.endAge))
```

### Pattern: Inflation Optionality

Some income sources are inflation-adjusted (Social Security COLA), others are fixed (most pensions). The type system should support both via an `inflationAdjusted` flag.

---

## Historical Context (from thoughts/)

### Story Progression
- **Story 3.1**: Core projection engine (completed) - [story-1-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-1-scope.md)
- **Story 3.2**: Visualization (completed) - [story-2-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-2-scope.md)
- **Story 3.3**: Assumption adjustments (completed) - [story-3-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-3-scope.md)
- **Story 3.4**: Multiple streams (current) - [story-4-scope.md](thoughts/personal/tickets/epic-3/projection-modeling/story-4-scope.md)

### Key Implementation Plans
- [2025-12-18-epic-3-story-1-projection-engine.md](thoughts/shared/plans/2025-12-18-epic-3-story-1-projection-engine.md) - Original engine design
- [2025-12-17-epic-3-projection-engine-implementation-readiness.md](thoughts/shared/research/2025-12-17-epic-3-projection-engine-implementation-readiness.md) - Algorithm research

---

## Related Research

- [2025-12-17-epic-3-projection-engine-implementation-readiness.md](thoughts/shared/research/2025-12-17-epic-3-projection-engine-implementation-readiness.md) - Comprehensive projection algorithm research
- [2025-12-21-epic-3-story-2-visualization-research.md](thoughts/shared/research/2025-12-21-epic-3-story-2-visualization-research.md) - Chart and visualization patterns
- [2025-12-25-story-2.4-adjust-assumptions-research.md](thoughts/shared/research/2025-12-25-story-2.4-adjust-assumptions-research.md) - Assumption adjustment patterns

---

## Architectural Decision: Income Streams in Financial Profile

**Decision**: Income streams are part of the user's **financial profile**, not projection-time configuration.

### Rationale

Income streams represent factual financial data about the user's expected retirement income sources (Social Security, pensions, rental properties, etc.). This is fundamentally different from projection assumptions like inflation rate or expected return, which are modeling parameters.

### Implementation Implications

1. **Storage**: Income streams stored as JSONB array in `financial_snapshot` table (alongside existing `investmentAccounts`, `debts`, etc.)

2. **Collection**: New onboarding step (or extension of existing step) to collect income stream data

3. **Projection Flow**:
   - Financial profile provides income streams as facts
   - Projection engine reads them from snapshot
   - Only inflation adjustment is a projection-time assumption

4. **Editing**: Users edit income streams via financial profile UI, not projection assumptions panel

### Data Flow

```
Onboarding → financial_snapshot.incomeStreams (JSONB)
                        ↓
              API reads from snapshot
                        ↓
              ProjectionInput.incomeStreams
                        ↓
              Engine calculates income per year
```

---

## Open Questions

1. ~~**Income taxation modeling**~~: **Deferred.** Skip for Story 3.4. Current system uses simplified gross income model without tax modeling. Adding partial taxability (e.g., 85% SS taxable) would require tax brackets, marginal rates, and withdrawal tax interactions. Future "tax optimization" story.

2. ~~**Part-time work during early retirement**~~: **Already solved.** The `IncomeStream` model supports `startAge` and `endAge`, so part-time work from 62-67 is just an income stream with `{ startAge: 62, endAge: 67, inflationAdjusted: false }`. No special handling needed.

3. ~~**Expense categories vs. single target**~~: **Decision: Keep simple.** Retain current general + healthcare split. The 5% healthcare inflation already handles the main outlier. Users can mentally adjust their general spending number. Multiple expense categories adds onboarding complexity for marginal benefit. Focus this story on income streams.

4. ~~**Backward compatibility**~~: **Auto-migrate at read time.** No database migration needed. When API reads snapshot: if `incomeStreams` exists, use it; otherwise construct SS stream on-the-fly from legacy `socialSecurityAge`/`socialSecurityMonthly` fields.

```typescript
const incomeStreams = snapshot.incomeStreams ??
  (snapshot.socialSecurityMonthly > 0 ? [{
    id: 'ss-legacy',
    name: 'Social Security',
    type: 'social_security',
    annualAmount: snapshot.socialSecurityMonthly * 12,
    startAge: snapshot.socialSecurityAge ?? 67,
    inflationAdjusted: true
  }] : []);
```

---

## Acceptance Criteria Mapping

| Criterion | Current State | Implementation Needed |
|-----------|--------------|----------------------|
| Multiple income sources | Only Social Security | Add `IncomeStream[]` to types and engine |
| Income sources at different ages | SS has `socialSecurityAge` | Generalize to `startAge` per stream |
| Primary retirement spending target | `annualExpenses` exists | Rename/clarify as primary spending |
| Spending inflates after retirement | ✅ Already implemented | Preserve current logic |
| Combine asset growth + income + expenses | Partially done (SS only) | Loop over all income streams |
