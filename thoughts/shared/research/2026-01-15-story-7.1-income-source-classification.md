---
date: 2026-01-15T12:00:00-08:00
researcher: Claude
git_commit: bafc7c498db9dd8158d3bd0eb14c43566ff578fd
branch: main
repository: plan-smart
topic: "Story 7.1 – Income Source Classification Implementation Research"
tags: [research, codebase, income-modeling, tax-features, epic-7, onboarding]
status: complete
last_updated: 2026-01-15
last_updated_by: Claude
---

# Research: Story 7.1 – Income Source Classification Implementation

**Date**: 2026-01-15T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: bafc7c498db9dd8158d3bd0eb14c43566ff578fd
**Branch**: main
**Repository**: plan-smart

## Research Question

How should we implement Story 7.1 (Income Source Classification) to allow users to describe how they make money using real-world categories, so the system understands their tax exposure and planning flexibility?

## Summary

This research provides a comprehensive implementation recommendation for Story 7.1. The codebase already has strong foundations including:
- Existing `IncomeStream` type with 6 income types (social_security, pension, rental, annuity, part_time, other)
- Multi-step onboarding flow with established patterns
- Form architecture using React Hook Form + Zod + Radix UI
- Database schema with JSONB columns for flexible data storage

**Recommended Approach**: Extend the existing `IncomeStream` model with new income source types and tax flexibility metadata, implement as a new onboarding step or profile section, and use card-based multi-select UI following established patterns.

## Detailed Findings

### 1. Current Income Modeling Architecture

#### Existing IncomeStream Type
Location: `src/types/onboarding.ts:187-213`

```typescript
type IncomeStreamType = 'social_security' | 'pension' | 'rental' | 'annuity' | 'part_time' | 'other'

interface IncomeStream {
  id: string;
  name: string;
  type: IncomeStreamType;
  annualAmount: number;
  startAge: number;
  endAge?: number;
  inflationAdjusted: boolean;
}
```

This models **retirement income streams** but not **working-age income sources** as required by Story 7.1.

#### Current Database Schema
Location: `src/db/schema/financial-snapshot.ts`

The `financial_snapshot` table stores:
- `annualIncome` (numeric) - Single annual income value
- `incomeStreams` (JSONB) - Array of `IncomeStreamJson[]` for retirement income

**Gap**: No current modeling of income source TYPE (W-2 vs 1099 vs business) or flexibility attributes.

### 2. Story 7.1 Requirements Analysis

#### Required Income Types (from scope)
1. **W-2 employment** - Traditional employment with tax withholding
2. **Self-employed / sole proprietor** - Schedule C income
3. **Business owner (LLC / S-Corp)** - Pass-through entity income
4. **Contract / 1099** - Independent contractor income
5. **Rental income** - Passive real estate income (already exists in IncomeStream)
6. **Investment income** - Dividends, capital gains, interest

#### Required Flexibility Attributes
- **Recurring vs variable** - Income predictability
- **Ability to reduce, defer, or restructure** - Tax planning flexibility

### 3. Recommended Data Model

#### New Type Definitions
Create `src/types/income-sources.ts`:

```typescript
// Income source categories (tax-relevant classification)
export type IncomeSourceType =
  | 'w2_employment'
  | 'self_employed'
  | 'business_owner'
  | 'contract_1099'
  | 'rental_income'
  | 'investment_income';

// Income variability
export type IncomeVariability = 'recurring' | 'variable' | 'seasonal';

// Tax flexibility options
export type TaxFlexibility = {
  canDefer: boolean;      // Can defer income to future years
  canReduce: boolean;     // Can reduce through deductions/expenses
  canRestructure: boolean; // Can change entity structure
};

// Complete income source model
export interface IncomeSource {
  id: string;
  type: IncomeSourceType;
  label: string;                    // User-friendly display name
  annualAmount: number;
  variability: IncomeVariability;
  flexibility: TaxFlexibility;
  isPrimary: boolean;               // Primary income source flag
  notes?: string;                   // Optional user notes
}

// UI option definitions with plain-language descriptions
export const INCOME_SOURCE_OPTIONS: Array<{
  value: IncomeSourceType;
  label: string;
  description: string;
  defaultFlexibility: TaxFlexibility;
}> = [
  {
    value: 'w2_employment',
    label: 'W-2 Employment',
    description: 'Regular job with taxes withheld from paycheck',
    defaultFlexibility: { canDefer: false, canReduce: false, canRestructure: false }
  },
  {
    value: 'self_employed',
    label: 'Self-Employed / Sole Proprietor',
    description: 'Freelance work or own business without formal entity',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: true }
  },
  {
    value: 'business_owner',
    label: 'Business Owner (LLC / S-Corp)',
    description: 'Own a business through a formal legal entity',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: true }
  },
  {
    value: 'contract_1099',
    label: 'Contract / 1099 Work',
    description: 'Independent contractor or consulting work',
    defaultFlexibility: { canDefer: true, canReduce: true, canRestructure: false }
  },
  {
    value: 'rental_income',
    label: 'Rental Income',
    description: 'Income from renting out property',
    defaultFlexibility: { canDefer: false, canReduce: true, canRestructure: false }
  },
  {
    value: 'investment_income',
    label: 'Investment Income',
    description: 'Dividends, interest, or capital gains',
    defaultFlexibility: { canDefer: true, canReduce: false, canRestructure: false }
  }
];
```

### 4. Database Schema Extension

#### Option A: Extend financial_snapshot (Recommended)
Add new JSONB column to existing table:

```sql
ALTER TABLE financial_snapshot
ADD COLUMN income_sources jsonb DEFAULT '[]'::jsonb;
```

Drizzle schema update in `src/db/schema/financial-snapshot.ts`:
```typescript
incomeSources: jsonb('income_sources').$type<IncomeSourceJson[]>().default([]),
```

#### Option B: New Dedicated Table
If income sources need separate versioning/history:

```sql
CREATE TABLE income_sources (
  id uuid PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id uuid REFERENCES user_profile(id) ON DELETE CASCADE,
  sources jsonb NOT NULL DEFAULT '[]',
  created_at timestamptz DEFAULT now(),
  updated_at timestamptz DEFAULT now()
);
```

**Recommendation**: Option A - keeps data co-located with other financial data, simpler queries, matches existing pattern.

### 5. UI Implementation Approach

#### Location in App Flow

**Option 1: New Onboarding Step** (Recommended for MVP)
Insert between Step 3 (Income/Savings) and Step 4 (Risk Tolerance):
- Step 3: Annual Income & Savings Rate
- **Step 3b: Income Source Classification** (NEW)
- Step 4: Risk Tolerance

**Option 2: Profile Section**
Add expandable section to Profile page alongside existing sections.

**Option 3: Both**
Collect during onboarding, allow editing in profile.

#### Component Architecture

Create `src/components/onboarding/step-income-sources.tsx`:

```typescript
// Follow existing patterns from step4-risk-tolerance.tsx (card-based selection)
// and step-income-streams.tsx (dynamic field array)

interface IncomeSourcesStepProps {
  initialData?: OnboardingStepIncomeSourcesData;
  onNext: (data: OnboardingStepIncomeSourcesData) => void;
  onBack: () => void;
}

export function IncomeSourcesStep({ initialData, onNext, onBack }: IncomeSourcesStepProps) {
  // 1. Card-based multi-select for income types (similar to risk tolerance cards)
  // 2. For each selected type, show inline form for amount + variability
  // 3. Show flexibility attributes as read-only badges (auto-set based on type)
  // 4. Allow marking one as "primary"
}
```

#### UI Pattern Recommendations

1. **Multi-Select Cards**: Use card-based selection (like risk tolerance) allowing multiple selections
2. **Progressive Disclosure**: Only show detail fields after type is selected
3. **Plain Language**: Use descriptions, not tax jargon
4. **Smart Defaults**: Auto-populate flexibility based on income type
5. **Collapsible Sections**: For each selected income source, show collapsible detail panel

#### Existing Patterns to Follow

| Pattern | Source File | Usage |
|---------|-------------|-------|
| Card-based selection | `step4-risk-tolerance.tsx:80-96` | Selection UI |
| Dynamic field array | `step-income-streams.tsx:68-71` | Multiple income sources |
| Collapsible sections | `step4b-assets-debts.tsx:208-222` | Detail expansion |
| Radio groups | `step2-retirement-info.tsx:80-105` | Variability selection |
| Checkbox controls | `step-income-streams.tsx:203-213` | Boolean toggles |

### 6. Validation Schema

Add to `src/lib/validation/onboarding.ts`:

```typescript
import { z } from 'zod';

const incomeSourceTypeSchema = z.enum([
  'w2_employment',
  'self_employed',
  'business_owner',
  'contract_1099',
  'rental_income',
  'investment_income'
]);

const incomeVariabilitySchema = z.enum(['recurring', 'variable', 'seasonal']);

const taxFlexibilitySchema = z.object({
  canDefer: z.boolean(),
  canReduce: z.boolean(),
  canRestructure: z.boolean(),
});

export const incomeSourceSchema = z.object({
  id: z.string().min(1),
  type: incomeSourceTypeSchema,
  label: z.string().min(1),
  annualAmount: z.number().min(0).max(100_000_000),
  variability: incomeVariabilitySchema,
  flexibility: taxFlexibilitySchema,
  isPrimary: z.boolean(),
  notes: z.string().optional(),
});

export const incomeSourcesStepSchema = z.object({
  incomeSources: z.array(incomeSourceSchema).min(1, 'At least one income source is required'),
}).refine(
  (data) => data.incomeSources.filter(s => s.isPrimary).length === 1,
  { message: 'Exactly one income source must be marked as primary' }
);
```

### 7. Integration with Projections

#### Downstream Impact Analysis

The projection engine (`src/lib/projections/engine.ts`) currently uses:
- `annualIncome` - Single value for working-age income
- `incomeStreams` - Retirement income streams

**Enhancements for Tax-Aware Projections**:

1. **Income Variability Handling**:
   - Recurring: Use stated amount directly
   - Variable: Apply conservative estimate (e.g., 85% of stated)
   - Seasonal: Weight by months active

2. **Tax Flexibility Application**:
   - `canDefer`: Model income deferral strategies in tax optimization
   - `canReduce`: Factor in potential deduction opportunities
   - `canRestructure`: Flag for future entity optimization suggestions

3. **Aggregate vs Detailed**:
   - Sum of all income sources replaces single `annualIncome`
   - Keep detailed breakdown for tax optimization features in Epic 7

#### Projection Input Updates

In `src/lib/projections/input-builder.ts`:

```typescript
// Update buildProjectionInputFromSnapshot to aggregate income sources
const totalAnnualIncome = snapshot.incomeSources?.length > 0
  ? snapshot.incomeSources.reduce((sum, source) => sum + source.annualAmount, 0)
  : snapshot.annualIncome ?? 0;
```

### 8. Migration Strategy

#### Phase 1: Schema Addition
1. Create migration adding `income_sources` JSONB column
2. Column is nullable/defaults to empty array
3. Existing users continue working with legacy `annualIncome`

#### Phase 2: Onboarding Update
1. Add new step to onboarding flow
2. Calculate total income from sources, store in both places for compatibility
3. New users get full experience

#### Phase 3: Migration Prompt
1. Existing users see prompt to "Update income details"
2. Pre-populate single income source from existing `annualIncome`
3. Allow them to split/categorize

#### Phase 4: Deprecation (Future)
1. Once adoption is high, deprecate `annualIncome` column
2. Update all queries to use aggregated income sources

### 9. File Structure Recommendation

```
src/
├── types/
│   └── income-sources.ts              # New: Type definitions
├── lib/
│   └── validation/
│       └── income-sources.ts          # New: Zod schemas
├── components/
│   └── onboarding/
│       └── step-income-sources.tsx    # New: Onboarding step
├── db/
│   └── schema/
│       └── financial-snapshot.ts      # Modified: Add column
│   └── migrations/
│       └── 0008_add_income_sources.sql # New: Migration
```

### 10. Acceptance Criteria Mapping

| Requirement | Implementation |
|-------------|----------------|
| User selects one or more income types | Multi-select card UI with INCOME_SOURCE_OPTIONS |
| W-2, Self-employed, Business owner, 1099, Rental, Investment | 6 enum values in IncomeSourceType |
| Recurring vs variable | `variability` field with 3 options |
| Ability to reduce, defer, restructure | `flexibility` object with 3 boolean flags |
| Language avoids tax jargon | Plain-language descriptions in INCOME_SOURCE_OPTIONS |

## Code References

- `src/types/onboarding.ts:187-213` - Existing IncomeStream type
- `src/db/schema/financial-snapshot.ts:1-90` - Financial snapshot schema
- `src/components/onboarding/step4-risk-tolerance.tsx:80-96` - Card selection pattern
- `src/components/onboarding/step-income-streams.tsx:68-71` - Field array pattern
- `src/components/onboarding/step4b-assets-debts.tsx:208-222` - Collapsible pattern
- `src/lib/validation/onboarding.ts:109-117` - Validation schema pattern
- `src/lib/projections/input-builder.ts:32-101` - Projection input building

## Architecture Insights

### Design Decisions

1. **JSONB over Normalized Tables**: Matches existing pattern for flexible financial data, simpler queries, no JOINs needed
2. **Type + Flexibility Split**: Separates "what" (type) from "how flexible" (flexibility) allowing overrides
3. **Default Flexibility Values**: Auto-set based on income type reduces user friction
4. **Multi-Select Pattern**: Users often have multiple income sources; single-select would be limiting
5. **Plain Language First**: Descriptions avoid tax form numbers (W-2, 1099) in favor of explanatory text

### Potential Concerns

1. **Schema Migration**: Existing users need migration path
2. **Projection Compatibility**: Need to maintain backward compatibility with `annualIncome`
3. **Complexity Creep**: Guard against over-engineering the flexibility attributes

## Historical Context (from thoughts/)

- `thoughts/shared/research/2025-12-26-story-3.4-multiple-income-expense-streams-research.md` - Prior research on income streams
- `thoughts/shared/plans/2025-12-29-story-3.4-multiple-income-streams.md` - Multiple income streams implementation
- `thoughts/shared/plans/2025-12-10-epic-2-onboarding-wizard-implementation.md` - Onboarding patterns and schema design

## Implementation Roadmap

### Sprint 1: Foundation
1. Create type definitions (`src/types/income-sources.ts`)
2. Add Zod validation schemas
3. Create database migration
4. Update Drizzle schema

### Sprint 2: UI Implementation
1. Build `IncomeSourcesStep` component
2. Integrate into onboarding flow
3. Add to profile page editing
4. Implement form validation

### Sprint 3: Integration
1. Update projection input builder
2. Add API endpoints for income source CRUD
3. Create migration prompts for existing users

### Sprint 4: Polish
1. Add unit tests
2. Add E2E tests for new onboarding step
3. Update documentation

## Open Questions

1. **Should rental income be separate?** Currently exists in both `IncomeStream` (retirement) and would be in `IncomeSource` (working-age). Consider unification.

2. **How detailed should flexibility be?** Current proposal has 3 boolean flags. Consider if more granular control is needed (e.g., percentage deferrals).

3. **Entity structure details for business owners?** Should we capture LLC vs S-Corp vs C-Corp distinction, or keep it simple as "business owner"?

4. **Income verification?** Future consideration: should users be able to link accounts for verification?

5. **Multi-year income history?** Should we capture historical income for trend analysis, or just current year?
