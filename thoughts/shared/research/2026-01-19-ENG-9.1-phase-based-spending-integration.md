---
date: 2026-01-19T12:00:00-08:00
researcher: Claude
git_commit: 23084eb768fea82ed60f71fdfcd95e276bb0ae49
branch: main
repository: plan-smart
topic: "How to integrate phase-based spending into existing architecture"
tags: [research, codebase, spending-phases, projection-engine, epic-9, integration]
status: complete
last_updated: 2026-01-19
last_updated_by: Claude
---

# Research: Integrating Phase-Based Spending into Existing Architecture

**Date**: 2026-01-19T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: 23084eb768fea82ed60f71fdfcd95e276bb0ae49
**Branch**: main
**Repository**: plan-smart

## Research Question

How should phase-based spending (Go-Go, Slow-Go, No-Go retirement phases) be integrated into the existing PlanSmart projection engine and data architecture?

## Summary

The existing architecture is **well-positioned** for phase-based spending integration. The projection engine already has:
1. A clear two-phase model (accumulation vs. drawdown)
2. Separate essential/discretionary expense tracking
3. Inflation multiplier infrastructure
4. Age-based income stream handling

**Key Integration Points:**
- **Data Model**: Add `SpendingPhaseConfig` to `financial_snapshot` schema
- **Projection Engine**: Modify expense calculation in drawdown phase (engine.ts:164-177)
- **Input Builder**: Transform phase config into projection input (input-builder.ts)
- **UI**: New component for phase configuration, similar to existing step components
- **API**: Update projection calculate endpoint to accept phase overrides

## Detailed Findings

### 1. Current Expense Calculation Architecture

The projection engine calculates expenses in a single location during the drawdown phase:

**File**: [engine.ts:164-177](src/lib/projections/engine.ts#L164-L177)

```typescript
// Current implementation (simplified)
const inflationMultiplier = Math.pow(1 + input.inflationRate, yearsFromRetirement);
const essentialExpenses = (input.annualEssentialExpenses ?? input.annualExpenses) * inflationMultiplier;
const discretionaryExpenses = (input.annualDiscretionaryExpenses ?? 0) * inflationMultiplier;
const generalExpenses = essentialExpenses + discretionaryExpenses;
```

**Integration Opportunity**: Insert phase multiplier calculation between base expense retrieval and inflation adjustment.

### 2. Proposed Data Model Changes

#### New Types ([types.ts](src/lib/projections/types.ts))

```typescript
// Add to src/lib/projections/types.ts

export interface SpendingPhase {
  id: string;
  name: string;
  startAge: number;
  endAge?: number;  // Inferred from next phase or maxAge
  spendingMultiplier: number;  // 1.0 = 100% of base spending
  absoluteAmount?: number;  // Optional override for specific amount
}

export interface SpendingPhaseConfig {
  enabled: boolean;
  phases: SpendingPhase[];
  baseAnnualSpending: number;  // Reference point for multipliers
}

// Add to ProjectionInput interface (line ~116)
export interface ProjectionInput {
  // ... existing fields ...
  spendingPhaseConfig?: SpendingPhaseConfig;
}
```

#### Database Schema ([financial-snapshot.ts](src/db/schema/financial-snapshot.ts))

```typescript
// Add new JSON type (around line 40)
export type SpendingPhaseJson = {
  id: string;
  name: string;
  startAge: number;
  endAge?: number;
  spendingMultiplier: number;
  absoluteAmount?: number;
};

export type SpendingPhaseConfigJson = {
  enabled: boolean;
  phases: SpendingPhaseJson[];
  baseAnnualSpending: number;
};

// Add column to financial_snapshot table (around line 115)
spendingPhases: jsonb('spending_phases').$type<SpendingPhaseConfigJson>(),
```

### 3. Default Phase Configuration

**File**: [assumptions.ts](src/lib/projections/assumptions.ts)

```typescript
// Add around line 60

export const DEFAULT_SPENDING_PHASES: SpendingPhase[] = [
  { id: 'go-go', name: 'Go-Go Years', startAge: 65, spendingMultiplier: 1.05 },
  { id: 'slow-go', name: 'Slow-Go', startAge: 75, spendingMultiplier: 0.85 },
  { id: 'no-go', name: 'No-Go', startAge: 85, spendingMultiplier: 0.65 },
];

export function getDefaultSpendingPhaseConfig(retirementAge: number): SpendingPhaseConfig {
  // Adjust first phase to start at actual retirement age
  const phases = DEFAULT_SPENDING_PHASES.map((phase, index) => ({
    ...phase,
    startAge: index === 0 ? retirementAge : phase.startAge,
  }));

  return {
    enabled: true,
    phases,
    baseAnnualSpending: 0, // Will be set from actual expenses
  };
}
```

### 4. Engine Modification

**File**: [engine.ts:164-177](src/lib/projections/engine.ts#L164-L177)

```typescript
// Replace current expense calculation with:

// DRAWDOWN PHASE
const yearsFromRetirement = age - input.retirementAge;
const inflationMultiplier = Math.pow(1 + input.inflationRate, yearsFromRetirement);

// NEW: Calculate phase multiplier
const phaseMultiplier = getPhaseMultiplierForAge(age, input.spendingPhaseConfig);

// Apply phase multiplier BEFORE inflation
const baseEssential = input.annualEssentialExpenses ?? input.annualExpenses;
const baseDiscretionary = input.annualDiscretionaryExpenses ?? 0;

const essentialExpenses = baseEssential * phaseMultiplier * inflationMultiplier;
const discretionaryExpenses = baseDiscretionary * phaseMultiplier * inflationMultiplier;
const generalExpenses = essentialExpenses + discretionaryExpenses;

// Healthcare unchanged (separate inflation)
const healthcareInflationMultiplier = Math.pow(1 + input.healthcareInflationRate, yearsFromRetirement);
const healthcareExpenses = input.annualHealthcareCosts * healthcareInflationMultiplier;

const expensesNeeded = generalExpenses + healthcareExpenses;
```

**New Helper Function** (add to engine.ts around line 45):

```typescript
function getPhaseMultiplierForAge(
  age: number,
  config?: SpendingPhaseConfig
): number {
  // If phases disabled or not configured, use flat spending (1.0)
  if (!config?.enabled || !config.phases.length) {
    return 1.0;
  }

  // Find the active phase for this age
  // Phases are ordered by startAge ascending
  const sortedPhases = [...config.phases].sort((a, b) => a.startAge - b.startAge);

  for (let i = sortedPhases.length - 1; i >= 0; i--) {
    if (age >= sortedPhases[i].startAge) {
      return sortedPhases[i].spendingMultiplier;
    }
  }

  // Before first phase starts (shouldn't happen in normal use)
  return 1.0;
}
```

### 5. Input Builder Integration

**File**: [input-builder.ts](src/lib/projections/input-builder.ts)

Add phase config transformation in `buildProjectionInputFromSnapshot()` (around line 85):

```typescript
// Build spending phase config
const spendingPhaseConfig = buildSpendingPhaseConfig(snapshot, overrides);

// ... in return statement (line ~140)
return {
  // ... existing fields ...
  spendingPhaseConfig,
};
```

**New Helper Function**:

```typescript
function buildSpendingPhaseConfig(
  snapshot: FinancialSnapshotRow,
  overrides?: ProjectionOverrides
): SpendingPhaseConfig | undefined {
  // Override takes precedence
  if (overrides?.spendingPhaseConfig) {
    return overrides.spendingPhaseConfig;
  }

  // Use snapshot config if exists
  if (snapshot.spendingPhases) {
    return snapshot.spendingPhases;
  }

  // Return undefined to use default flat spending
  // (or return getDefaultSpendingPhaseConfig(retirementAge) for opt-out)
  return undefined;
}
```

### 6. API Endpoint Updates

**File**: [route.ts](src/app/api/projections/calculate/route.ts)

Update `ProjectionOverrides` interface and validation schema:

```typescript
// In projectionRequestSchema (lib/validation/projections.ts)
spendingPhaseConfig: z.object({
  enabled: z.boolean(),
  phases: z.array(z.object({
    id: z.string(),
    name: z.string(),
    startAge: z.number().min(50).max(100),
    spendingMultiplier: z.number().min(0.1).max(2.0),
    absoluteAmount: z.number().optional(),
  })).min(1).max(4),
  baseAnnualSpending: z.number().min(0),
}).optional(),
```

### 7. UI Component Structure

Following the existing pattern in [step3b-income-expenses.tsx](src/components/onboarding/step3b-income-expenses.tsx):

**New Component**: `src/components/onboarding/step-spending-phases.tsx`

```typescript
interface SpendingPhasesStepProps {
  initialData?: SpendingPhaseConfig;
  retirementAge: number;
  onNext: (data: { spendingPhases: SpendingPhaseConfig }) => void;
  onBack: () => void;
  onChange?: (isDirty: boolean) => void;
  submitLabel?: string;
  cancelLabel?: string;
}
```

**UI Elements Needed**:
1. Enable/disable toggle for phase-based spending
2. Phase list with add/remove buttons (1-4 phases)
3. Per-phase inputs:
   - Name (text input)
   - Start age (number input with validation)
   - Spending multiplier (slider or number input, display as percentage)
4. Visual preview showing phase timeline
5. Validation: no gaps, no overlaps, ordered by age

**Integration Points**:
- Add to onboarding wizard as optional advanced step
- Add to profile page as new Collapsible section
- Add edit dialog similar to [profile-client.tsx:641-655](src/app/profile/profile-client.tsx#L641-L655)

### 8. Projection Record Enhancement

**File**: [types.ts](src/lib/projections/types.ts) - ProjectionRecord interface

```typescript
export interface ProjectionRecord {
  // ... existing fields ...

  // NEW: Add phase information for UI display
  activePhase?: {
    id: string;
    name: string;
    multiplier: number;
  };
  phaseAdjustedExpenses?: number;  // Expenses after phase multiplier, before inflation
}
```

This allows the chart to visualize which phase is active at each age and show the spending curve.

### 9. Income Floor Integration

The income floor analysis ([income-floor.ts](src/lib/projections/income-floor.ts)) should also account for phase-based spending:

```typescript
// In calculateIncomeFloor (around line 50)
const phaseMultiplier = getPhaseMultiplierForAge(age, input.spendingPhaseConfig);
const essentialExpenses = input.annualEssentialExpenses * phaseMultiplier * inflationMultiplier;
```

This ensures the income floor coverage ratio reflects actual phase-adjusted spending.

## Architecture Insights

### Design Decisions

1. **Phase Multiplier Applied Before Inflation**: The multiplier adjusts the base spending level, then inflation compounds on top. This models realistic behavior where lifestyle changes are intentional, not inflationary.

2. **Optional/Opt-In Model**: Phase-based spending is disabled by default (`undefined` config means flat 1.0 multiplier). Users opt-in through settings. This maintains backward compatibility.

3. **Essential + Discretionary Both Affected**: Both expense types receive the phase multiplier. In reality, discretionary spending might decrease more dramatically than essential, but this simplification aligns with the story scope. Future enhancement could have per-type multipliers.

4. **Healthcare Excluded from Phase Adjustment**: Healthcare costs increase with age (separate inflation rate), which is opposite to the general spending decline pattern. The current architecture already handles this correctly.

5. **Validation at Boundaries**: Phase boundaries must be validated to prevent gaps/overlaps. This is a UI responsibility with schema validation backup.

### Data Flow

```
User Input (UI)
    ↓
SpendingPhaseConfig (JSON in financial_snapshot)
    ↓
buildProjectionInputFromSnapshot() [input-builder.ts]
    ↓
ProjectionInput.spendingPhaseConfig
    ↓
runProjection() [engine.ts]
    ↓
getPhaseMultiplierForAge() per year
    ↓
Phase-adjusted expenses in ProjectionRecord
    ↓
Chart/UI displays spending curve with phase annotations
```

## Code References

### Files to Modify

| File | Lines | Change |
|------|-------|--------|
| [src/lib/projections/types.ts](src/lib/projections/types.ts) | 76-116 | Add SpendingPhase, SpendingPhaseConfig interfaces; update ProjectionInput |
| [src/lib/projections/engine.ts](src/lib/projections/engine.ts#L164-L177) | 164-177 | Insert phase multiplier calculation |
| [src/lib/projections/engine.ts](src/lib/projections/engine.ts#L45) | ~45 | Add getPhaseMultiplierForAge() helper |
| [src/lib/projections/assumptions.ts](src/lib/projections/assumptions.ts) | ~60 | Add DEFAULT_SPENDING_PHASES constant |
| [src/lib/projections/input-builder.ts](src/lib/projections/input-builder.ts#L34) | 34-141 | Add phase config transformation |
| [src/lib/projections/income-floor.ts](src/lib/projections/income-floor.ts#L50) | ~50 | Apply phase multiplier to essential expenses |
| [src/db/schema/financial-snapshot.ts](src/db/schema/financial-snapshot.ts) | ~40, ~115 | Add JSON types and column |
| [src/lib/validation/projections.ts](src/lib/validation/projections.ts) | new | Add spendingPhaseConfig schema |
| [src/app/api/projections/calculate/route.ts](src/app/api/projections/calculate/route.ts) | ~221-238 | Include phase config in projection input |

### New Files to Create

| File | Purpose |
|------|---------|
| `src/components/onboarding/step-spending-phases.tsx` | UI for configuring spending phases |
| `src/components/spending-phase-editor.tsx` | Reusable phase editor component |

## Historical Context (from thoughts/)

### Epic 9 Story Documents
- [story-1-scope.md](thoughts/personal/tickets/epic-9/story-1-scope.md) - Defines the Life Phase Definition feature with acceptance criteria
- [story-2-scope.md](thoughts/personal/tickets/epic-9/story-2-scope.md) - Front-loaded spending support
- [story-3-scope.md](thoughts/personal/tickets/epic-9/story-3-scope.md) - Visual spending timeline

### Related Implementation Plans
- [2025-12-18-epic-3-story-1-projection-engine.md](thoughts/shared/plans/2025-12-18-epic-3-story-1-projection-engine.md) - Original projection engine design
- [2026-01-16-epic-8-safety-first-income-floor-modeling.md](thoughts/shared/plans/2026-01-16-epic-8-safety-first-income-floor-modeling.md) - Income floor integration context

### Key Design Philosophy
From Epic 9 differentiator:
> "ProjectionLab optimizes for smoothness. **PlanSmart optimizes for life reality.**"

The phase-based spending model recognizes that:
1. Healthy retirees want to travel, pursue hobbies, and enjoy life (Go-Go)
2. Spending naturally decreases as mobility and interests change (Slow-Go)
3. Generic flat assumptions punish intentional front-loading (No-Go)

## Related Research

- [2025-12-17-epic-3-projection-engine-implementation-readiness.md](thoughts/shared/research/2025-12-17-epic-3-projection-engine-implementation-readiness.md) - Original engine architecture
- [2026-01-16-epic-8-implementation-gap-analysis.md](thoughts/shared/research/2026-01-16-epic-8-implementation-gap-analysis.md) - Income floor gap analysis (related feature)

## Open Questions

1. **Default Behavior**: Should new users get phase-based spending enabled by default, or opt-in? The story suggests "Spending curves are non-flat by default" for existing users.

2. **Migration Strategy**: How to handle existing users' projections? Options:
   - Keep flat until they enable phases (safest)
   - Auto-enable with defaults and notify (more aligned with epic goal)

3. **Per-Expense-Type Multipliers**: Should essential and discretionary have separate phase multipliers? The current design applies the same multiplier to both.

4. **Absolute Amount Override**: The story mentions `absoluteAmount` as an alternative to multiplier. Implementation details TBD - when would a user prefer absolute amounts?

5. **Phase Visualization**: Story 9.3 covers visual timeline. Should phase annotations appear on the main projection chart, or only in a dedicated phases view?

## Implementation Recommendation

### Phased Approach

**Phase 1: Core Engine (Story 9.1)**
1. Add types and interfaces
2. Implement `getPhaseMultiplierForAge()` helper
3. Modify engine expense calculation
4. Add default phase configuration
5. Update input builder
6. Add API override support

**Phase 2: Data Persistence**
1. Add database schema column
2. Create migration
3. Update API profile endpoint
4. Add validation schema

**Phase 3: UI (can parallel with Phase 2)**
1. Create phase editor component
2. Add to profile page
3. Add to onboarding (optional step)
4. Implement validation UX

**Phase 4: Visualization (Story 9.3)**
1. Enhance projection record with phase data
2. Add phase annotations to chart
3. Create dedicated spending timeline view

This approach allows the core functionality to be tested and validated before building the full UI experience.
