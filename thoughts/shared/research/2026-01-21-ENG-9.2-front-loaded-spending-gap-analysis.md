---
date: 2026-01-21T10:30:00-08:00
researcher: Claude
git_commit: e8ac7f3c1fceaebdeeb7bee7fa75dcc821feb97b
branch: main
repository: plan-smart
topic: "Story 9.2 Front-Loaded Spending Implementation Gap Analysis"
tags: [research, codebase, epic-9, spending-phases, front-loaded-spending, implementation-gap]
status: complete
last_updated: 2026-01-21
last_updated_by: Claude
---

# Research: Story 9.2 Front-Loaded Spending Implementation Gap Analysis

**Date**: 2026-01-21T10:30:00-08:00
**Researcher**: Claude
**Git Commit**: e8ac7f3c1fceaebdeeb7bee7fa75dcc821feb97b
**Branch**: main
**Repository**: plan-smart

## Research Question

Analyze the implementation gap between the Story 9.2 acceptance criteria (Front-Loaded Spending Support) and the current codebase state.

## Summary

**Good news**: The projection engine core is fully implemented and supports phase-based spending with multipliers and absolute amounts. The gap is primarily in the **UI/UX layer** for comparing flat vs phased spending and visualizing the impact.

| Acceptance Criteria | Status | Gap |
|---------------------|--------|-----|
| "Front-load spending" toggle or explicit spending curve option | Partial | Toggle exists but needs reframing as "Flat vs Life-Phase" mode selector |
| Phase-based spending multipliers in projection engine | **Complete** | None - fully implemented |
| Shows impact on portfolio longevity | Partial | Engine calculates, UI needs comparison view |
| Calculates "breakeven" point | **Not Implemented** | Need `SpendingComparison` interface and comparison logic |
| Comparison view: flat vs phase-based spending | **Not Implemented** | No side-by-side comparison UI |
| Neutral framing (no penalty messaging) | N/A | Requires UX review when building comparison UI |
| Clear visualization of spending trajectory | **Not Implemented** | No spending trajectory chart exists |

## Detailed Findings

### What's Already Implemented (Story 9.1 Complete)

#### Projection Engine (`src/lib/projections/engine.ts`)

The projection engine fully supports phase-based spending:

- **`calculatePhaseAdjustedExpenses()`** ([engine.ts:139-166](src/lib/projections/engine.ts#L139-L166)) - Calculates spending based on active phase
- **`getActivePhaseForAge()`** ([engine.ts:115-133](src/lib/projections/engine.ts#L115-L133)) - Determines which phase applies at a given age
- **Year-by-year integration** ([engine.ts:222-248](src/lib/projections/engine.ts#L222-L248)) - Applies phase adjustment before inflation

Key behavior:
1. Phase multipliers are applied to base expenses first
2. Inflation is applied after phase adjustment
3. Absolute amounts override multipliers when specified
4. Records include `activePhaseId` and `activePhaseName` for UI display

#### Type System (`src/lib/projections/types.ts`)

Complete type definitions exist:

```typescript
// Lines 76-89
interface SpendingPhase {
  id: string;
  name: string;
  startAge: number;
  endAge?: number;
  essentialMultiplier: number;
  discretionaryMultiplier: number;
  absoluteEssential?: number;
  absoluteDiscretionary?: number;
}

// Lines 94-97
interface SpendingPhaseConfig {
  enabled: boolean;
  phases: SpendingPhase[];
}
```

#### Default Phases (`src/lib/projections/assumptions.ts`)

Default "Go-Go, Slow-Go, No-Go" phases are defined ([assumptions.ts:78-100](src/lib/projections/assumptions.ts#L78-L100)):

| Phase | Start Age | Essential | Discretionary |
|-------|-----------|-----------|---------------|
| Go-Go Years | 65 | 100% | 110% |
| Slow-Go | 75 | 95% | 75% |
| No-Go | 85 | 90% | 50% |

#### UI Components

- **SpendingPhaseEditor** ([spending-phase-editor.tsx](src/components/spending-phase-editor.tsx)) - Full phase configuration UI with:
  - Enable/disable toggle
  - Phase name, start age inputs
  - Essential and discretionary sliders/inputs
  - Toggle between multiplier and absolute amount modes
  - Add/remove phase functionality

- **Integration**: Used in Profile page ([profile-client.tsx](src/app/profile/profile-client.tsx))

#### Database & API

- **Schema** ([financial-snapshot.ts:132](src/db/schema/financial-snapshot.ts#L132)) - `spendingPhases` JSONB column
- **Validation** ([projections.ts:6-48](src/lib/validation/projections.ts#L6-L48)) - Zod schemas with multiplier bounds
- **API** ([route.ts:239-241](src/app/api/projections/calculate/route.ts#L239-L241)) - Override support for `spendingPhaseConfig`

---

### What's Missing for Story 9.2

#### 1. SpendingComparison Interface and Logic

**Specified in scope but not implemented:**

```typescript
// FROM story-2-scope.md - NOT IN CODEBASE
interface SpendingComparison {
  flatSpending: {
    totalLifetimeSpending: number;
    portfolioDepletionAge: number | null;
    endingBalance: number;
  };
  phasedSpending: {
    totalLifetimeSpending: number;
    portfolioDepletionAge: number | null;
    endingBalance: number;
    earlyYearsBonus: number;  // Extra spending in Go-Go years vs flat
  };
  breakEvenAge: number | null;  // Age where cumulative spending equals
}
```

**Implementation needed:**
- New file: `src/lib/projections/spending-comparison.ts`
- Function to run two projections (flat vs phased) and compute comparison metrics
- Break-even calculation logic

#### 2. Spending Mode Toggle/Selector

**Current state**: The `SpendingPhaseEditor` has an enable/disable toggle, but it's buried in the configuration.

**Story 9.2 requires**: A prominent "Flat vs Life-Phase" mode selector, ideally at the top of the spending configuration or as a comparison view toggle.

**Suggested implementation:**
- New component: `SpendingModeSelector`
- Options: "Flat Spending" vs "Life-Phase Spending"
- When "Life-Phase" is selected, show the phase editor
- When toggling, show immediate preview of impact

#### 3. Comparison View UI

**Not implemented**: No component exists to show flat vs phase-based spending side-by-side.

**Story 9.2 requires:**
- Side-by-side or overlay chart of spending trajectories
- Impact summary showing trade-offs
- "Spending $X more in first 10 years, portfolio lasts until age Y"

**Suggested components:**
- `SpendingComparisonChart` - Dual-line chart or overlay showing both trajectories
- `SpendingImpactSummary` - Card showing key comparison metrics
- Integration in Plans or Profile page

#### 4. Spending Trajectory Visualization

**Current state**: `ProjectionChart` ([ProjectionChart.tsx](src/components/projections/ProjectionChart.tsx)) shows balance over time but NOT spending.

**Story 9.2 requires**: "Clear visualization of spending trajectory over time"

**Suggested implementation:**
- New component: `SpendingTrajectoryChart`
- X-axis: Age or Year
- Y-axis: Annual spending (real or nominal)
- Color-coded regions for each phase
- Optional: Overlay flat spending as reference line

---

### Implementation Recommendations

#### Phase 1: Core Comparison Logic
1. Create `SpendingComparison` interface in `types.ts`
2. Create `src/lib/projections/spending-comparison.ts` with:
   - `calculateSpendingComparison(input: ProjectionInput): SpendingComparison`
   - Runs projection twice: once with phases enabled, once disabled
   - Calculates break-even age
   - Computes early-years bonus

#### Phase 2: Spending Trajectory Chart
1. Create `SpendingTrajectoryChart` component
2. Show spending amounts per year with phase coloring
3. Add toggle to show flat spending overlay
4. Integrate with existing projection data

#### Phase 3: Comparison UI
1. Create `SpendingComparisonView` or enhance existing projection view
2. Add `SpendingImpactSummary` card
3. Ensure neutral framing in all messaging

#### Phase 4: Mode Selector Enhancement
1. Create prominent `SpendingModeSelector` component
2. Place at top of spending configuration
3. Show immediate impact preview when toggling

---

## Code References

### Existing (Complete)
- [engine.ts:139-166](src/lib/projections/engine.ts#L139-L166) - `calculatePhaseAdjustedExpenses()` function
- [engine.ts:115-133](src/lib/projections/engine.ts#L115-L133) - `getActivePhaseForAge()` function
- [types.ts:76-97](src/lib/projections/types.ts#L76-L97) - `SpendingPhase` and `SpendingPhaseConfig` interfaces
- [assumptions.ts:78-100](src/lib/projections/assumptions.ts#L78-L100) - Default spending phases
- [spending-phase-editor.tsx](src/components/spending-phase-editor.tsx) - Phase editor component
- [projections.ts:6-48](src/lib/validation/projections.ts#L6-L48) - Validation schemas

### To Be Created
- `src/lib/projections/spending-comparison.ts` - Comparison calculation logic
- `src/lib/projections/types.ts` - Add `SpendingComparison` interface
- `src/components/spending-trajectory-chart.tsx` - Spending visualization
- `src/components/spending-comparison-view.tsx` - Comparison UI
- `src/components/spending-impact-summary.tsx` - Impact metrics card
- `src/components/spending-mode-selector.tsx` - Mode toggle component

---

## Architecture Insights

### Current Architecture Strengths
1. **Clean separation**: Engine logic is isolated from UI
2. **Override pattern**: API supports per-request overrides, making comparison easy
3. **Type safety**: Full TypeScript coverage with Zod validation
4. **Testability**: Comprehensive test suite exists for engine functions

### Design Considerations for Story 9.2
1. **Comparison should be computed, not stored**: Run projections on-demand rather than storing comparison results
2. **Reuse existing projection API**: Add `compareSpending` endpoint or compute client-side from two calls
3. **Chart library**: Use existing recharts integration (already used in ProjectionChart)
4. **Neutral framing**: Avoid language like "penalty" or "safe" - use factual comparisons

---

## Historical Context (from thoughts/)

- [story-1-scope.md](thoughts/personal/tickets/epic-9/story-1-scope.md) - Story 9.1 defined the core phase system
- [story-2-scope.md](thoughts/personal/tickets/epic-9/story-2-scope.md) - Story 9.2 scope being analyzed
- [story-3-scope.md](thoughts/personal/tickets/epic-9/story-3-scope.md) - Story 9.3 covers visual spending timeline
- [2026-01-19-ENG-9.1-phase-based-spending-implementation.md](thoughts/shared/plans/2026-01-19-ENG-9.1-phase-based-spending-implementation.md) - Story 9.1 implementation plan
- [2026-01-19-ENG-9.1-phase-based-spending-integration.md](thoughts/shared/research/2026-01-19-ENG-9.1-phase-based-spending-integration.md) - Story 9.1 research

---

## Related Research

- [2026-01-19-ENG-9.1-phase-based-spending-integration.md](thoughts/shared/research/2026-01-19-ENG-9.1-phase-based-spending-integration.md) - Prior research on phase-based spending integration

---

## Open Questions

1. **Where should comparison UI live?** Options:
   - Dedicated "Compare" tab in projections view
   - Inline in spending phase editor with toggle
   - New "What-If" scenarios feature

2. **Break-even calculation method**: Should it compare cumulative spending or portfolio outcomes?

3. **Story 9.3 overlap**: The spending trajectory chart may partially satisfy both Story 9.2 and 9.3. Consider implementing once for both.

4. **API design**: Add new `/api/projections/compare` endpoint or compute comparison client-side?
