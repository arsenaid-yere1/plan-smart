---
date: 2026-01-22T12:00:00-08:00
researcher: Claude
git_commit: a1dec5e80b910fdc19f62403f8fe2aca4f1f4f39
branch: main
repository: plan-smart
topic: "How the existing projection chart is implemented (to integrate spending phases)"
tags: [research, codebase, projection-chart, recharts, spending-phases, epic-9]
status: complete
last_updated: 2026-01-22
last_updated_by: Claude
---

# Research: Projection Chart Implementation for Spending Phase Integration

**Date**: 2026-01-22T12:00:00-08:00
**Researcher**: Claude
**Git Commit**: a1dec5e80b910fdc19f62403f8fe2aca4f1f4f39
**Branch**: main
**Repository**: plan-smart

## Research Question

How is the existing projection chart implemented, and what is required to integrate spending phases (visual spending timeline) per Story 9.3?

## Summary

The projection chart uses **Recharts 3.6.0** with a `ComposedChart` that combines Area and Line elements. The architecture already supports spending phase data via `ProjectionRecord.activePhaseName` and `ProjectionRecord.activePhaseId` fields added in Epic 9. A separate `SpendingTrajectoryChart` component already exists for spending visualization in the "Compare Spending" tab. Story 9.3 requires integrating spending as an overlay layer on the main `ProjectionChart`, with phase boundaries shown as vertical reference lines.

## Detailed Findings

### 1. ProjectionChart Component

**Location**: [ProjectionChart.tsx](src/components/projections/ProjectionChart.tsx)

**Chart Configuration**:
- Uses `ComposedChart` from Recharts (line 230)
- Wrapped in `ResponsiveContainer` for responsive sizing
- Height: `h-64 sm:h-80 lg:h-96` (responsive)
- Margin: `{ top: 20, right: 10, left: 0, bottom: 0 }`

**Data Flow**:
1. Receives `records: ProjectionRecord[]` from parent (line 20)
2. Uses `useMemo` to transform records into chart-compatible format (lines 55-124)
3. Transforms include:
   - Inflation adjustment (`adjustForInflation` state)
   - X-axis value mapping (age vs year)
   - Balance splitting into accumulation/retirement phases
   - Zero-crossing interpolation for shortfall visualization

**Key Props**:
```typescript
interface ProjectionChartProps {
  records: ProjectionRecord[];
  retirementAge: number;
  currentAge: number;
  inflationRate?: number;
  shortfallAge?: number;
}
```

**Visual Layers (Current)**:
1. `CartesianGrid` - Dashed horizontal lines (line 234)
2. `XAxis` - Age or Year values (line 239)
3. `YAxis` - Currency formatted (line 245)
4. `Tooltip` - Custom content showing balance, phase name (line 252-300)
5. `ReferenceLine` - Retirement age marker (line 310)
6. `ReferenceLine` - Shortfall marker when applicable (line 322)
7. `Area` - Accumulation phase fill (line 336)
8. `Area` - Retirement phase fill (line 345)
9. `Line` - Positive balance line (line 354)
10. `Line` - Negative balance line for shortfall (line 369)

**Phase Data Already in Tooltip** (lines 294-296):
```typescript
<p className="mt-1 text-xs text-muted-foreground">
  {data.activePhaseName || (data.isRetirement ? 'Retirement Phase' : 'Accumulation Phase')}
</p>
```

### 2. SpendingTrajectoryChart Component

**Location**: [SpendingTrajectoryChart.tsx](src/components/projections/SpendingTrajectoryChart.tsx)

This component already visualizes spending over time with phase information. Key patterns to reuse:

**Phase Colors** (lines 35-40):
```typescript
const PHASE_COLORS: Record<string, string> = {
  'Go-Go Years': 'hsl(var(--success))',
  'Slow-Go': 'hsl(var(--warning))',
  'No-Go': 'hsl(var(--muted-foreground))',
  default: 'hsl(var(--primary))',
};
```

**Phase Boundary Reference Lines** (lines 97-109, 189-203):
```typescript
const phaseBoundaries = useMemo(() => {
  const boundaries: { age: number; phase: string }[] = [];
  let currentPhase: string | null = null;
  for (const point of data) {
    if (point.phase !== currentPhase && point.phase) {
      boundaries.push({ age: point.age, phase: point.phase });
      currentPhase = point.phase;
    }
  }
  return boundaries;
}, [data]);

// Rendered as:
{phaseBoundaries.slice(1).map((boundary) => (
  <ReferenceLine
    key={boundary.age}
    x={boundary.age}
    stroke="hsl(var(--muted-foreground))"
    strokeDasharray="5 5"
    label={{ value: boundary.phase, position: 'top', fontSize: 10 }}
  />
))}
```

### 3. ProjectionRecord Type

**Location**: [types.ts:186-204](src/lib/projections/types.ts#L186-L204)

```typescript
export interface ProjectionRecord {
  age: number;
  year: number;
  balance: number;
  inflows: number;
  outflows: number;
  balanceByType: BalanceByType;
  withdrawalsByType?: BalanceByType;
  essentialExpenses?: number;      // Epic 8
  discretionaryExpenses?: number;  // Epic 8
  activePhaseId?: string;          // Epic 9 - already present!
  activePhaseName?: string;        // Epic 9 - already present!
}
```

**Key Finding**: The `activePhaseName` and `activePhaseId` fields are already populated by the projection engine during drawdown phase (engine.ts:287-288).

### 4. Projection Engine - Phase Population

**Location**: [engine.ts:230-288](src/lib/projections/engine.ts#L230-L288)

The engine already calculates phase-adjusted expenses and tracks the active phase:

```typescript
const phaseResult = calculatePhaseAdjustedExpenses(
  age,
  baseEssential,
  baseDiscretionary,
  input.spendingPhaseConfig
);

// ...later in record creation:
activePhaseId: currentActivePhaseId,
activePhaseName: currentActivePhaseName,
```

### 5. Data Flow Architecture

```
User Profile (spendingPhaseConfig)
    ↓
Financial Snapshot (DB)
    ↓
/api/projections/calculate
    ↓
input-builder.ts → ProjectionInput (with spendingPhaseConfig)
    ↓
engine.ts → runProjection()
    ↓
ProjectionResult.records[] (with activePhaseId, activePhaseName, essentialExpenses, discretionaryExpenses)
    ↓
PlansClient (plans-client.tsx)
    ↓
ProjectionChart (receives records)
```

### 6. Existing Integration Point

**Location**: [plans-client.tsx:480-486](src/app/plans/plans-client.tsx#L480-L486)

```typescript
<ProjectionChart
  records={projection.records}
  retirementAge={assumptions.retirementAge}
  currentAge={currentAge}
  inflationRate={assumptions.inflationRate}
  shortfallAge={shortfallAge}
/>
```

## Code References

| File | Lines | Description |
|------|-------|-------------|
| `src/components/projections/ProjectionChart.tsx` | 1-421 | Main projection chart component |
| `src/components/projections/ProjectionChart.tsx` | 55-124 | Data transformation with useMemo |
| `src/components/projections/ProjectionChart.tsx` | 294-296 | Tooltip already shows activePhaseName |
| `src/components/projections/SpendingTrajectoryChart.tsx` | 35-40 | Phase color definitions |
| `src/components/projections/SpendingTrajectoryChart.tsx` | 97-109 | Phase boundary calculation |
| `src/components/projections/SpendingTrajectoryChart.tsx` | 189-203 | Phase reference lines rendering |
| `src/lib/projections/types.ts` | 186-204 | ProjectionRecord with phase fields |
| `src/lib/projections/engine.ts` | 230-288 | Phase calculation in projection |
| `src/app/plans/plans-client.tsx` | 480-486 | Chart integration point |

## Architecture Insights

### Integration Strategy for Story 9.3

Based on the recommended "Option C: Integrated with Portfolio Chart" from the story scope, here's how to add spending visualization:

1. **Add Spending Line/Area to ProjectionChart**:
   - Add new `dataKey` for `outflows` (expenses) to chart data
   - Render as secondary Y-axis or normalized overlay
   - Use phase colors from `PHASE_COLORS` constant

2. **Add Phase Boundary Reference Lines**:
   - Reuse pattern from `SpendingTrajectoryChart`
   - Calculate boundaries from `activePhaseName` changes in records
   - Render as vertical dashed lines with labels

3. **Extend Props**:
   ```typescript
   interface ProjectionChartProps {
     // existing...
     showSpending?: boolean;  // toggle spending overlay
     spendingPhases?: SpendingPhase[];  // for boundary calculation
   }
   ```

4. **Tooltip Enhancement**:
   - Already shows `activePhaseName` (line 294-296)
   - Add spending breakdown (essentialExpenses + discretionaryExpenses)
   - Show phase multiplier if available

5. **Legend Enhancement**:
   - Add spending line indicator
   - Add phase color indicators (reuse from SpendingTrajectoryChart)

### Key Considerations

1. **Dual Y-Axis**: Balance (portfolio) and Spending have vastly different scales. Options:
   - Secondary Y-axis on right side
   - Normalized percentage view
   - Separate toggle between "Balance" and "Spending" views

2. **Phase Colors**: Use existing `PHASE_COLORS` from SpendingTrajectoryChart for consistency

3. **Mobile Responsiveness**: Current chart already handles responsive sizing well

4. **Nominal vs Real Toggle**: Already implemented - spending overlay should respect this setting

## Historical Context (from thoughts/)

- `thoughts/personal/tickets/epic-9/story-3-scope.md` - Story 9.3 acceptance criteria and design philosophy
- `thoughts/shared/plans/2026-01-21-ENG-9.2-front-loaded-spending-comparison.md` - Related spending comparison implementation
- `thoughts/shared/research/2026-01-19-ENG-9.1-phase-based-spending-integration.md` - Phase-based spending integration research

## Related Research

- `thoughts/shared/research/2026-01-21-ENG-9.2-front-loaded-spending-gap-analysis.md` - Gap analysis for spending comparison

## Open Questions

1. **Y-Axis Strategy**: Should spending use a secondary Y-axis, normalized percentage, or a separate toggle view?

2. **Phase Boundary Labeling**: Should labels appear at top of chart (like current retirement marker) or along the x-axis?

3. **Color Scheme**: Should phase regions use background fills (like current accumulation/retirement areas) or just boundary lines?

4. **Click Interaction**: The scope mentions "Click phase to edit its parameters" - this would require:
   - Making phase regions clickable
   - Opening a phase editor modal
   - Integration with `/profile` spending phase settings

5. **Data Availability**: `essentialExpenses` and `discretionaryExpenses` are only populated during retirement phase. Should accumulation phase show projected spending at retirement rates?
